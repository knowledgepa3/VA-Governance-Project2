<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GIA | Get Started</title>
  <meta name="description" content="Set up your GIA governed AI workspace. Choose your domain, configure governance, and launch your first workflow.">
  <link rel="icon" type="image/svg+xml" href="/shared/gia-icon.svg">
  <script src="/shared/gia-core.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --dark: #0a0a0f;
      --dark-lighter: #12121a;
      --gray-900: #18181b;
      --gray-800: #27272a;
      --gray-700: #3f3f46;
      --gray-600: #52525b;
      --gray-500: #71717a;
      --gray-400: #a1a1aa;
      --gray-300: #d4d4d8;
      --white: #ffffff;
      --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 50%, var(--secondary) 100%);
      --err: #ef4444;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark);
      color: var(--white);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Background grid */
    .bg-grid {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-image:
        linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }

    /* Header */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      padding: 1rem 2rem;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(99, 102, 241, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 900;
      letter-spacing: -0.03em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-badge {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 4px;
      color: var(--primary-light);
      -webkit-text-fill-color: var(--primary-light);
    }

    nav { display: flex; gap: 2rem; align-items: center; }
    nav a { color: var(--gray-400); text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; }
    nav a:hover { color: var(--white); }

    /* Main */
    main {
      position: relative;
      z-index: 1;
      padding-top: 120px;
      padding-bottom: 4rem;
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-header .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 100px;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--primary-light);
      margin-bottom: 1.5rem;
    }

    .page-header .dot {
      width: 8px; height: 8px;
      background: var(--secondary);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 1rem;
      line-height: 1.1;
    }

    .page-header h1 .gradient {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-header .subtitle {
      font-size: 1.1rem;
      color: var(--gray-400);
      max-width: 500px;
      margin: 0 auto;
    }

    /* Form Card */
    .form-card {
      background: var(--gray-900);
      border: 1px solid var(--gray-700);
      border-radius: 16px;
      padding: 2.5rem;
    }

    .form-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary-light);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--gray-800);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
    }

    .form-sublabel {
      display: block;
      color: var(--gray-500);
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--dark);
      border: 1.5px solid var(--gray-700);
      border-radius: 8px;
      color: var(--white);
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .form-input::placeholder { color: var(--gray-600); }

    /* Domain Cards */
    .domain-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .domain-option { position: relative; }

    .domain-option input {
      position: absolute;
      opacity: 0;
      width: 0; height: 0;
    }

    .domain-option label {
      display: block;
      padding: 1rem;
      background: var(--dark);
      border: 1.5px solid var(--gray-700);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .domain-option input:checked + label {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.08);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    .domain-option label:hover {
      border-color: var(--gray-500);
    }

    .domain-icon {
      font-size: 1.5rem;
      margin-bottom: 0.4rem;
    }

    .domain-title {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.15rem;
    }

    .domain-desc {
      font-size: 0.7rem;
      color: var(--gray-500);
      line-height: 1.3;
    }

    /* Governance Mode */
    .gov-options {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .gov-option {
      flex: 1;
      position: relative;
    }

    .gov-option input {
      position: absolute;
      opacity: 0;
    }

    .gov-option label {
      display: block;
      padding: 0.75rem;
      text-align: center;
      background: var(--dark);
      border: 1.5px solid var(--gray-700);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gov-option input:checked + label {
      border-color: var(--secondary);
      background: rgba(16, 185, 129, 0.08);
    }

    .gov-option label:hover {
      border-color: var(--gray-500);
    }

    .gov-name {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .gov-desc {
      font-size: 0.7rem;
      color: var(--gray-500);
      margin-top: 0.15rem;
    }

    /* Custom domain / wishlist builder */
    .custom-domain-group {
      display: none;
    }

    .custom-domain-group.visible {
      display: block;
      animation: fadeSlideIn 0.3s ease;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wishlist-builder {
      background: rgba(99, 102, 241, 0.04);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 0.75rem;
    }

    .wishlist-builder .form-group { margin-bottom: 1rem; }
    .wishlist-builder .form-group:last-child { margin-bottom: 0; }

    .wishlist-textarea {
      width: 100%;
      min-height: 80px;
      max-height: 200px;
      resize: vertical;
      background: var(--gray-900);
      border: 1px solid var(--gray-700);
      border-radius: 8px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.85rem;
      padding: 0.75rem;
      line-height: 1.5;
      transition: border-color 0.2s;
    }
    .wishlist-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
    }
    .wishlist-textarea::placeholder { color: var(--gray-600); }

    .capability-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .capability-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      border: 1px solid var(--gray-700);
      background: var(--gray-900);
      color: var(--gray-400);
    }

    .capability-chip:hover {
      border-color: var(--primary);
      color: var(--primary-light);
      background: rgba(99, 102, 241, 0.08);
    }

    .capability-chip.selected {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.15);
      color: var(--primary-light);
    }

    .capability-chip .chip-icon { font-size: 0.85rem; }

    .wishlist-hint {
      font-size: 0.7rem;
      color: var(--gray-600);
      margin-top: 0.5rem;
      font-style: italic;
    }

    /* Divider */
    .form-divider {
      height: 1px;
      background: var(--gray-800);
      margin: 2rem 0;
    }

    /* Validation */
    .validation-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--err);
      color: var(--err);
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      display: none;
    }

    .validation-error.show {
      display: block;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 1rem;
      background: var(--gradient-primary);
      border: none;
      border-radius: 10px;
      color: var(--white);
      font-size: 1.05rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: wait;
      transform: none;
    }

    .form-footer {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1.25rem;
      font-size: 0.8rem;
      color: var(--gray-500);
    }

    .form-footer span { color: var(--secondary); }

    /* Confirmation */
    .confirmation {
      display: none;
      text-align: center;
      padding: 3rem 2rem;
    }

    .confirmation.show {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .confirmation-check {
      width: 64px; height: 64px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.15);
      border: 2px solid var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
    }

    .confirmation h2 {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .confirmation p {
      color: var(--gray-400);
      margin-bottom: 1.5rem;
      font-size: 1rem;
    }

    .launch-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 2rem;
    }

    .launch-card {
      background: var(--dark);
      border: 1px solid var(--gray-700);
      border-radius: 10px;
      padding: 1.25rem;
      text-decoration: none;
      color: var(--white);
      transition: all 0.2s;
      text-align: center;
    }

    .launch-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
    }

    .launch-card-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .launch-card-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
    .launch-card-desc { font-size: 0.75rem; color: var(--gray-500); }

    /* Footer */
    footer {
      border-top: 1px solid var(--gray-800);
      padding: 2rem;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .footer-text { color: var(--gray-500); font-size: 0.85rem; }
    .footer-links { display: flex; justify-content: center; gap: 2rem; margin-top: 0.75rem; }
    .footer-links a { color: var(--gray-400); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; }
    .footer-links a:hover { color: var(--white); }

    /* Dynamic Config Display */
    .config-section {
      background: var(--dark);
      border: 1px solid var(--gray-700);
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      text-align: left;
    }

    .config-section-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-500);
      margin-bottom: 0.75rem;
    }

    .config-match {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .config-match-type {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .config-match-confidence {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      font-weight: 600;
    }

    .confidence-high { background: rgba(16, 185, 129, 0.15); color: var(--secondary); border: 1px solid rgba(16, 185, 129, 0.3); }
    .confidence-med { background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
    .confidence-low { background: rgba(239, 68, 68, 0.15); color: var(--err); border: 1px solid rgba(239, 68, 68, 0.3); }

    .config-rationale {
      font-size: 0.8rem;
      color: var(--gray-400);
      line-height: 1.4;
    }

    .pipeline-roles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .pipeline-role {
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 6px;
      color: var(--primary-light);
      font-weight: 500;
    }

    .badge-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .gov-badge {
      font-size: 0.75rem;
      padding: 0.3rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .badge-mandatory { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge-advisory { background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
    .badge-informational { background: rgba(16, 185, 129, 0.15); color: var(--secondary); border: 1px solid rgba(16, 185, 129, 0.3); }
    .badge-high { background: rgba(249, 115, 22, 0.15); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.3); }
    .badge-limited { background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
    .badge-minimal { background: rgba(16, 185, 129, 0.15); color: var(--secondary); border: 1px solid rgba(16, 185, 129, 0.3); }

    .recommendations-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recommendations-list li {
      font-size: 0.8rem;
      color: var(--gray-400);
      padding: 0.3rem 0;
      padding-left: 1rem;
      position: relative;
    }

    .recommendations-list li::before {
      content: '\2192';
      position: absolute;
      left: 0;
      color: var(--primary-light);
    }

    /* Custom pipeline detail (for wishlist-generated workflows) */
    #configCustomDetail {
      border-left: 3px solid var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.06) 0%, rgba(16, 185, 129, 0.04) 100%);
    }

    #configCustomDetail .config-section-label {
      color: var(--primary-light);
    }

    .evidence-footer {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-800);
      font-size: 0.7rem;
      color: var(--gray-600);
      font-family: 'Courier New', monospace;
      text-align: center;
    }

    .progress-text {
      text-align: center;
      font-size: 0.85rem;
      color: var(--gray-400);
      margin-top: 1rem;
      animation: pulse 1.5s infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Registration Card */
    .register-card {
      display: none;
      margin-top: 2rem;
      background: var(--dark-lighter);
      border: 1px solid var(--gray-700);
      border-radius: 12px;
      padding: 2rem;
      text-align: left;
    }

    .register-card.show {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .register-card h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .register-card .reg-subtitle {
      color: var(--gray-400);
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
    }

    .register-card .form-group {
      margin-bottom: 1rem;
    }

    .register-card .form-label {
      font-size: 0.8rem;
    }

    .register-card .form-input {
      width: 100%;
    }

    .register-card .reg-btn {
      width: 100%;
      padding: 0.8rem;
      background: var(--gradient-primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .register-card .reg-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
    }

    .register-card .reg-btn:disabled {
      opacity: 0.6;
      cursor: wait;
      transform: none;
    }

    .register-card .reg-error {
      display: none;
      color: var(--err);
      font-size: 0.8rem;
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 6px;
    }

    .register-card .reg-error.show {
      display: block;
    }

    .register-card .reg-success {
      display: none;
      text-align: center;
      padding: 1.5rem 0;
    }

    .register-card .reg-success.show {
      display: block;
    }

    .register-card .reg-success h3 {
      text-align: center;
      color: var(--secondary);
      margin-bottom: 0.5rem;
    }

    .register-card .reg-success p {
      color: var(--gray-400);
      font-size: 0.85rem;
      text-align: center;
    }

    .register-card .skip-link {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: var(--gray-500);
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: none;
    }

    .register-card .skip-link:hover {
      color: var(--gray-300);
    }

    .tier-badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.15rem 0.5rem;
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 4px;
      color: var(--primary-light);
      margin-left: 0.5rem;
      vertical-align: middle;
    }

    /* Responsive */
    @media (max-width: 768px) {
      header { padding: 1rem; }
      nav { display: none; }
      main { padding-top: 100px; }
      .page-header h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      .form-card { padding: 1.5rem; }
      .domain-grid { grid-template-columns: repeat(2, 1fr); }
      .launch-grid { grid-template-columns: 1fr; }
      .wishlist-builder { padding: 1rem; }
      .capability-chips { gap: 0.35rem; }
      .capability-chip { padding: 0.3rem 0.6rem; font-size: 0.7rem; }
      .capability-chip .chip-icon { font-size: 0.75rem; }
      .wishlist-textarea { min-height: 60px; font-size: 0.8rem; }
      .badge-row { gap: 0.5rem; }
      .pipeline-roles { gap: 0.3rem; }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <header>
    <div class="header-content">
      <a href="/" class="logo">GIA <span class="logo-badge">PLATFORM</span></a>
      <nav>
        <a href="/">Home</a>
        <a href="/app">Workflows</a>
        <a href="/console">Console</a>
        <a href="/login" id="navAuthLink">Sign In</a>
      </nav>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          if (window.GIA && window.GIA.auth && window.GIA.auth.isLoggedIn()) {
            const link = document.getElementById('navAuthLink');
            link.textContent = window.GIA.auth.getDisplayName() || 'Console';
            link.href = '/console';
          }
        });
      </script>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <div class="eyebrow">
          <span class="dot"></span>
          Get Started
        </div>
        <h1>Set Up Your <span class="gradient">Governed</span> Workspace</h1>
        <p class="subtitle">Tell us about your team and what you need. We'll configure GIA for your domain.</p>
      </div>

      <!-- Form -->
      <div class="form-card" id="formCard">
        <form id="onboardingForm" action="https://formspree.io/f/xwvqggle" method="POST">
          <input type="hidden" name="_subject" value="New GIA Onboarding Signup">
          <input type="hidden" name="source" value="onboarding-wizard">

          <!-- Section: About You -->
          <div class="form-section-title">About You</div>

          <div class="form-group">
            <label class="form-label" for="orgName">Organization</label>
            <input type="text" class="form-input" id="orgName" name="organization" placeholder="Your company or team name" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label" for="userName">Your Name</label>
              <input type="text" class="form-input" id="userName" name="name" placeholder="Full name" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="userEmail">Email</label>
              <input type="email" class="form-input" id="userEmail" name="email" placeholder="you@company.com" required>
            </div>
          </div>

          <div class="form-divider"></div>

          <!-- Section: Your Domain -->
          <div class="form-section-title">Your Domain</div>
          <p class="form-sublabel" style="margin-top: -0.5rem;">What type of work will GIA govern for you?</p>

          <div class="domain-grid">
            <div class="domain-option">
              <input type="radio" id="d-va" name="domain" value="VA Claims Support" checked>
              <label for="d-va">
                <div class="domain-icon">&#x1F4CB;</div>
                <div class="domain-title">VA Claims</div>
                <div class="domain-desc">Evidence analysis & rating support</div>
              </label>
            </div>
            <div class="domain-option">
              <input type="radio" id="d-bd" name="domain" value="Business Development">
              <label for="d-bd">
                <div class="domain-icon">&#x1F3AF;</div>
                <div class="domain-title">Business Dev</div>
                <div class="domain-desc">RFP capture & proposals</div>
              </label>
            </div>
            <div class="domain-option">
              <input type="radio" id="d-legal" name="domain" value="Legal & Compliance">
              <label for="d-legal">
                <div class="domain-icon">&#x2696;&#xFE0F;</div>
                <div class="domain-title">Legal</div>
                <div class="domain-desc">Contract review & policy</div>
              </label>
            </div>
            <div class="domain-option">
              <input type="radio" id="d-finance" name="domain" value="Finance & Accounting">
              <label for="d-finance">
                <div class="domain-icon">&#x1F4B0;</div>
                <div class="domain-title">Finance</div>
                <div class="domain-desc">Analysis & audit support</div>
              </label>
            </div>
            <div class="domain-option">
              <input type="radio" id="d-research" name="domain" value="Research & Analysis">
              <label for="d-research">
                <div class="domain-icon">&#x1F4CA;</div>
                <div class="domain-title">Research</div>
                <div class="domain-desc">Market intel & due diligence</div>
              </label>
            </div>
            <div class="domain-option">
              <input type="radio" id="d-custom" name="domain" value="Custom">
              <label for="d-custom">
                <div class="domain-icon">&#x26A1;</div>
                <div class="domain-title">Other</div>
                <div class="domain-desc">I'll describe below</div>
              </label>
            </div>
          </div>

          <div class="custom-domain-group" id="customDomainGroup">
            <div class="wishlist-builder">
              <div class="form-group">
                <label class="form-label" for="customDomain">Name Your Domain</label>
                <input type="text" class="form-input" id="customDomain" name="custom_domain" placeholder="e.g., Healthcare triage, Supply chain ops, HR onboarding..." maxlength="100">
              </div>

              <div class="form-group">
                <label class="form-label" for="customWishlist">Describe the workflow</label>
                <textarea class="wishlist-textarea" id="customWishlist" name="custom_wishlist" placeholder="What tasks should your agents perform? Be specific.&#10;&#10;Example: Scan an RFI PDF, extract requirements, create a response outline, build a compliance matrix, and generate a draft proposal..."
                  maxlength="1200"></textarea>
                <div class="wishlist-hint">Keep it focused. GIA works best with clear, specific task descriptions.</div>
              </div>

              <div class="form-group">
                <label class="form-label">Input types <span style="color:var(--gray-600);font-weight:400;">(what goes in)</span></label>
                <div class="capability-chips" id="inputChips">
                  <span class="capability-chip" data-cap="pdf"><span class="chip-icon">&#x1F4C4;</span> PDF</span>
                  <span class="capability-chip" data-cap="word"><span class="chip-icon">&#x1F4DD;</span> Word/Docs</span>
                  <span class="capability-chip" data-cap="csv"><span class="chip-icon">&#x1F4CA;</span> CSV/Excel</span>
                  <span class="capability-chip" data-cap="urls"><span class="chip-icon">&#x1F310;</span> URLs/Links</span>
                  <span class="capability-chip" data-cap="email"><span class="chip-icon">&#x2709;&#xFE0F;</span> Emails</span>
                  <span class="capability-chip" data-cap="images"><span class="chip-icon">&#x1F5BC;&#xFE0F;</span> Images</span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Output types <span style="color:var(--gray-600);font-weight:400;">(what comes out)</span></label>
                <div class="capability-chips" id="outputChips">
                  <span class="capability-chip" data-cap="report"><span class="chip-icon">&#x1F4CB;</span> Report</span>
                  <span class="capability-chip" data-cap="checklist"><span class="chip-icon">&#x2705;</span> Checklist</span>
                  <span class="capability-chip" data-cap="json"><span class="chip-icon">&#x1F4BE;</span> JSON Data</span>
                  <span class="capability-chip" data-cap="summary"><span class="chip-icon">&#x1F4DD;</span> Summary</span>
                  <span class="capability-chip" data-cap="timeline"><span class="chip-icon">&#x1F4C5;</span> Timeline</span>
                  <span class="capability-chip" data-cap="matrix"><span class="chip-icon">&#x1F4CA;</span> Matrix/Table</span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Constraints <span style="color:var(--gray-600);font-weight:400;">(safety boundaries)</span></label>
                <div class="capability-chips" id="constraintChips">
                  <span class="capability-chip" data-cap="no-pii"><span class="chip-icon">&#x1F512;</span> No PII stored</span>
                  <span class="capability-chip" data-cap="read-only"><span class="chip-icon">&#x1F441;&#xFE0F;</span> Read-only tools</span>
                  <span class="capability-chip" data-cap="human-approval"><span class="chip-icon">&#x270B;</span> Human approval req'd</span>
                  <span class="capability-chip" data-cap="no-external"><span class="chip-icon">&#x1F6AB;</span> No external API calls</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-divider"></div>

          <!-- Section: Governance Preference -->
          <div class="form-section-title">Governance Level</div>
          <p class="form-sublabel" style="margin-top: -0.5rem;">How much human oversight do you want on AI actions?</p>

          <div class="gov-options">
            <div class="gov-option">
              <input type="radio" id="g-advisory" name="governance" value="Advisory">
              <label for="g-advisory">
                <div class="gov-name">Advisory</div>
                <div class="gov-desc">Logged, no gates</div>
              </label>
            </div>
            <div class="gov-option">
              <input type="radio" id="g-strict" name="governance" value="Strict" checked>
              <label for="g-strict">
                <div class="gov-name">Strict</div>
                <div class="gov-desc">Approval gates on</div>
              </label>
            </div>
            <div class="gov-option">
              <input type="radio" id="g-regulated" name="governance" value="Regulated">
              <label for="g-regulated">
                <div class="gov-name">Regulated</div>
                <div class="gov-desc">Full evidence pack</div>
              </label>
            </div>
          </div>

          <!-- Honeypot: invisible to humans, bots auto-fill it -->
          <div style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true">
            <input type="text" name="website" id="honeyField" tabindex="-1" autocomplete="off">
          </div>

          <!-- Validation Error -->
          <div class="validation-error" id="validationError"></div>

          <!-- Submit -->
          <button type="submit" class="submit-btn" id="submitBtn">Get Started</button>

          <div class="form-footer">
            <div><span>&#x2713;</span> Free to start</div>
            <div><span>&#x2713;</span> No credit card</div>
            <div><span>&#x2713;</span> Full audit trail</div>
          </div>
        </form>
      </div>

      <!-- Confirmation (hidden by default — populated dynamically) -->
      <div class="form-card confirmation" id="confirmation">
        <div class="confirmation-check">&#x2713;</div>
        <h2 id="confirmTitle">Your Workspace is Ready</h2>
        <p id="confirmSubtitle">Here's your auto-configured governance profile. No data was stored — this was generated live.</p>

        <div style="display: inline-block; padding: 0.5rem 1.25rem; background: var(--dark); border: 1px solid var(--gray-700); border-radius: 8px; font-family: monospace; color: var(--secondary); font-size: 0.9rem;" id="runId"></div>
        <p style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-500);">Your setup ID</p>

        <!-- Dynamic config sections (populated by JS) -->
        <div id="configDisplay" style="margin-top: 2rem; text-align: left;">
          <!-- Workforce Match -->
          <div class="config-section" id="configMatch">
            <div class="config-section-label">Workforce Match</div>
            <div class="config-match">
              <span class="config-match-type" id="matchType">—</span>
              <span class="config-match-confidence" id="matchConfidence">—</span>
            </div>
            <div class="config-rationale" id="matchRationale"></div>
          </div>

          <!-- Agent Pipeline -->
          <div class="config-section" id="configPipeline">
            <div class="config-section-label">Agent Pipeline</div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;" id="pipelineName">—</div>
            <div class="pipeline-roles" id="pipelineRoles"></div>
          </div>

          <!-- Custom Pipeline Detail (shown only for custom workflows) -->
          <div class="config-section" id="configCustomDetail" style="display:none;">
            <div class="config-section-label">Custom Pipeline Design</div>
            <div style="font-size: 0.85rem; color: var(--gray-300); line-height: 1.6;" id="customPipelineDetail"></div>
            <div class="badge-row" id="constraintBadges" style="margin-top: 0.75rem;"></div>
          </div>

          <!-- Governance Profile -->
          <div class="config-section" id="configGovernance">
            <div class="config-section-label">Governance Profile</div>
            <div class="badge-row" id="govBadges"></div>
            <ul class="recommendations-list" id="govRecommendations"></ul>
          </div>
        </div>

        <!-- Launch Cards -->
        <div class="launch-grid" id="launchGrid"></div>

        <!-- Evidence footer -->
        <div class="evidence-footer" id="evidenceFooter"></div>

        <!-- Registration Card (appears after workspace is configured) -->
        <div class="register-card" id="registerCard">
          <div id="regForm">
            <h3>Create Your Account <span class="tier-badge">FREE</span></h3>
            <p class="reg-subtitle">Save your workspace and get 50 AI queries/month. No credit card required.</p>
            <p class="reg-subtitle" style="margin-top: -1rem; font-size: 0.75rem; color: var(--gray-600);">Creating an account stores your email, organization, and usage data. Your configuration above was generated live with no data stored.</p>

            <div class="reg-error" id="regError"></div>

            <div class="form-group">
              <label class="form-label" for="regEmail">Email</label>
              <input type="email" class="form-input" id="regEmail" placeholder="you@company.com" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label" for="regPassword">Password</label>
                <input type="password" class="form-input" id="regPassword" placeholder="Min 8 chars, letter + number" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="regPasswordConfirm">Confirm Password</label>
                <input type="password" class="form-input" id="regPasswordConfirm" placeholder="Confirm password" required>
              </div>
            </div>

            <button type="button" class="reg-btn" id="regBtn" onclick="handleRegistration()">Create Account</button>
            <a class="skip-link" onclick="document.getElementById('registerCard').style.display='none'">Skip for now</a>
          </div>

          <div class="reg-success" id="regSuccess">
            <h3>Account Created</h3>
            <p>You're logged in. Redirecting to your workspace...</p>
          </div>
        </div>

        <p style="margin-top: 1.5rem; font-size: 0.85rem; color: var(--gray-500);">
          Questions? <a href="mailto:support@aceadvising.com" style="color: var(--primary-light);">support@aceadvising.com</a>
        </p>
      </div>
    </div>
  </main>

  <footer>
    <p class="footer-text">GIA &middot; Governed Intelligence Architecture &middot; Built by ACE Advising</p>
    <div class="footer-links">
      <a href="/">Home</a>
      <a href="/app">Workflows</a>
      <a href="/console">Console</a>
      <a href="/bd">BD Dashboard</a>
    </div>
  </footer>

  <script>
    // Toggle custom domain wishlist builder
    document.querySelectorAll('input[name="domain"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const group = document.getElementById('customDomainGroup');
        group.classList.toggle('visible', document.getElementById('d-custom').checked);
      });
    });

    // Capability chip toggle (all chip groups)
    document.querySelectorAll('.capability-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.toggle('selected');
      });
    });

    function getChipSelections(containerId) {
      return Array.from(document.querySelectorAll('#' + containerId + ' .capability-chip.selected'))
        .map(c => c.dataset.cap);
    }

    function getWishlistPayload() {
      return {
        narrative: (document.getElementById('customWishlist')?.value || '').trim(),
        inputs: getChipSelections('inputChips'),
        outputs: getChipSelections('outputChips'),
        constraints: getChipSelections('constraintChips'),
      };
    }

    // Generate setup ID
    function generateId() {
      const d = new Date();
      const seq = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
      return `GIA-${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${seq}`;
    }

    // ═══════════════════════════════════════════════════════════════
    // DYNAMIC CONFIRMATION RENDERER
    // ═══════════════════════════════════════════════════════════════

    function renderDynamicConfirmation(config) {
      // Update title + labels for custom pipelines
      if (config.workforceMapping.isCustom) {
        document.getElementById('confirmTitle').textContent = 'Your Custom Pipeline is Ready';
        document.getElementById('confirmSubtitle').textContent = 'GIA designed a bespoke agent workforce based on your requirements. Review the pipeline below.';
        // Change "Workforce Match" label to "Pipeline Generated"
        document.querySelector('#configMatch .config-section-label').textContent = 'Pipeline Generated';
      }

      // Workforce match
      const matchType = document.getElementById('matchType');
      const matchConf = document.getElementById('matchConfidence');
      const matchRat = document.getElementById('matchRationale');

      matchType.textContent = config.agentPipeline.name;
      const confPct = Math.round(config.workforceMapping.matchConfidence * 100);
      // Custom pipelines show "confidence" not "match"
      matchConf.textContent = config.workforceMapping.isCustom
        ? confPct + '% confidence'
        : confPct + '% match';
      matchConf.className = 'config-match-confidence ' +
        (confPct >= 85 ? 'confidence-high' : confPct >= 60 ? 'confidence-med' : 'confidence-low');
      matchRat.textContent = config.workforceMapping.matchRationale;

      // Agent pipeline roles
      const pipelineNameEl = document.getElementById('pipelineName');
      const pipelineRoles = document.getElementById('pipelineRoles');
      // Show description only for template pipelines; custom ones get their detail section
      pipelineNameEl.textContent = config.workforceMapping.isCustom
        ? config.agentPipeline.name
        : config.agentPipeline.description;
      // Escape role names to prevent XSS from LLM-generated content
      const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      pipelineRoles.innerHTML = config.agentPipeline.roles
        .map(r => `<span class="pipeline-role">${esc(r)}</span>`).join('');

      // Custom pipeline detail (if custom/wishlist-generated)
      const customDetailSection = document.getElementById('configCustomDetail');
      const customDetailEl = document.getElementById('customPipelineDetail');
      const constraintBadgesEl = document.getElementById('constraintBadges');
      if (config.workforceMapping.isCustom && config.agentPipeline.description) {
        customDetailSection.style.display = 'block';
        customDetailEl.textContent = config.agentPipeline.description; // textContent is safe (no HTML parsing)

        // Show constraint badges from localStorage (what user selected)
        const savedConfig = JSON.parse(localStorage.getItem('gia_config') || '{}');
        const constraintLabels = {
          'no-pii': 'No PII Stored', 'read-only': 'Read-Only',
          'human-approval': 'Human Approval', 'no-external': 'No External APIs'
        };
        const selectedConstraints = savedConfig.constraints || [];
        if (selectedConstraints.length > 0) {
          constraintBadgesEl.innerHTML = selectedConstraints
            .map(c => `<span class="gov-badge" style="background:rgba(16,185,129,0.12);color:var(--secondary);border:1px solid rgba(16,185,129,0.25);font-size:0.7rem;">${constraintLabels[c] || c}</span>`)
            .join('');
        }
      } else {
        customDetailSection.style.display = 'none';
      }

      // Governance badges
      const govBadges = document.getElementById('govBadges');
      const mai = config.governanceProfile.maiClassification;
      const risk = config.governanceProfile.riskTier;
      const maiBadgeClass = 'badge-' + mai.classification.toLowerCase();
      const riskBadgeClass = 'badge-' + risk.tier.toLowerCase();

      govBadges.innerHTML =
        `<span class="gov-badge ${maiBadgeClass}">MAI: ${mai.classification}</span>` +
        `<span class="gov-badge ${riskBadgeClass}">Risk: ${risk.tier}</span>` +
        `<span class="gov-badge" style="background:rgba(99,102,241,0.15);color:var(--primary-light);border:1px solid rgba(99,102,241,0.3);">${config.governanceProfile.level}</span>`;

      // Recommendations
      const govRecs = document.getElementById('govRecommendations');
      govRecs.innerHTML = config.governanceProfile.recommendations
        .slice(0, 5)
        .map(r => `<li>${r}</li>`).join('');

      // Launch cards
      const launchGrid = document.getElementById('launchGrid');
      const iconMap = { workflow: '\uD83D\uDCCB', briefcase: '\uD83D\uDCBC', terminal: '\uD83D\uDDA5\uFE0F', globe: '\uD83C\uDF10' };
      launchGrid.innerHTML = config.launchConfig.links
        .map(link => `
          <a href="${esc(link.url)}" class="launch-card">
            <div class="launch-card-icon">${iconMap[link.icon] || '\uD83C\uDF10'}</div>
            <div class="launch-card-title">${esc(link.label)}</div>
            <div class="launch-card-desc">Launch workspace</div>
          </a>
        `).join('');

      // Evidence footer
      const evidenceFooter = document.getElementById('evidenceFooter');
      const sig = config.evidence.signature ? ` | sig:${config.evidence.signature.slice(0, 12)}` : '';
      evidenceFooter.textContent = `config:${config.evidence.configHash.slice(0, 16)} | v${config.evidence.policyVersion}${sig} | ${config.configurationId}`;

      // Show dynamic sections
      document.getElementById('configDisplay').style.display = 'block';
    }

    function renderStaticConfirmation() {
      // Hide dynamic sections, show basic confirmation
      document.getElementById('configDisplay').style.display = 'none';
      document.getElementById('confirmTitle').textContent = "You're In";
      document.getElementById('confirmSubtitle').textContent = "We're setting up your governed workspace. You'll hear from us shortly.";

      // Static launch cards
      document.getElementById('launchGrid').innerHTML = `
        <a href="/app" class="launch-card">
          <div class="launch-card-icon">\uD83D\uDCCB</div>
          <div class="launch-card-title">Workflows</div>
          <div class="launch-card-desc">Run the agent pipeline</div>
        </a>
        <a href="/console" class="launch-card">
          <div class="launch-card-icon">\uD83D\uDDA5\uFE0F</div>
          <div class="launch-card-title">Console</div>
          <div class="launch-card-desc">Terminal interface</div>
        </a>
        <a href="/" class="launch-card">
          <div class="launch-card-icon">\uD83C\uDF10</div>
          <div class="launch-card-title">Portal</div>
          <div class="launch-card-desc">All workflows</div>
        </a>
      `;
      document.getElementById('evidenceFooter').textContent = '';
    }

    // ═══════════════════════════════════════════════════════════════
    // FORM SUBMISSION (with double-submit guard + bot protection)
    // ═══════════════════════════════════════════════════════════════

    // Page load timestamp for bot timing detection
    const _pageLoadTime = Date.now();
    let _formspreeSubmitted = false; // Prevent duplicate Formspree submissions
    let _submitting = false;         // Double-submit lock

    document.getElementById('onboardingForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Double-submit guard
      if (_submitting) return;
      _submitting = true;

      const form = this;
      const btn = document.getElementById('submitBtn');
      const errEl = document.getElementById('validationError');

      // Validate
      const org = document.getElementById('orgName').value.trim();
      const name = document.getElementById('userName').value.trim();
      const email = document.getElementById('userEmail').value.trim();

      if (!org || !name || !email) {
        errEl.textContent = 'Please fill in all required fields.';
        errEl.classList.add('show');
        _submitting = false;
        return;
      }
      if (!email.includes('@') || !email.includes('.')) {
        errEl.textContent = 'Please enter a valid email address.';
        errEl.classList.add('show');
        _submitting = false;
        return;
      }

      // Validate custom domain: name is required, narrative is encouraged
      const isCustomDomain = document.getElementById('d-custom').checked;
      if (isCustomDomain) {
        const customName = document.getElementById('customDomain').value.trim();
        if (!customName) {
          errEl.textContent = 'Please name your custom domain (e.g., "Healthcare triage").';
          errEl.classList.add('show');
          document.getElementById('customDomain').focus();
          _submitting = false;
          return;
        }
      }
      errEl.classList.remove('show');

      // Disable button + show progress
      btn.disabled = true;
      btn.textContent = 'Configuring workspace...';
      btn.style.opacity = '0.6';

      // Collect form data
      const formData = new FormData(form);
      const data = {};
      formData.forEach((val, key) => { data[key] = val; });

      // Add setup ID and timestamp
      const setupId = generateId();
      data.setup_id = setupId;
      data.signup_date = new Date().toISOString();

      // If custom domain was selected, build the structured wishlist payload
      if (data.domain === 'Custom') {
        const customName = document.getElementById('customDomain').value.trim();
        data.domain = customName ? 'Custom: ' + customName : 'Custom';
        const wl = getWishlistPayload();
        data.wishlist = wl.narrative;
        data.inputs = wl.inputs;
        data.outputs = wl.outputs;
        data.constraints = wl.constraints;
      }

      // Add progress text (different for custom wishlists)
      const isCustom = document.getElementById('d-custom').checked;
      const progressEl = document.createElement('div');
      progressEl.className = 'progress-text';
      progressEl.textContent = isCustom ? 'Designing your custom pipeline...' : 'Analyzing your domain...';
      btn.parentNode.insertBefore(progressEl, btn.nextSibling.nextSibling);

      try {
        // ── Parallel requests: Formspree (once) + Configure API ──

        // Only submit to Formspree once (prevent duplicate on retry)
        const formspreePromise = _formspreeSubmitted
          ? Promise.resolve()
          : fetch('https://formspree.io/f/xwvqggle', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify(data)
            }).then(() => { _formspreeSubmitted = true; }).catch(err => {
              console.warn('[Onboarding] Formspree error:', err.message);
            });

        const configPromise = (async () => {
          try {
            progressEl.textContent = isCustom ? 'Building agent roles from your wishlist...' : 'Running governance classification...';

            const controller = new AbortController();
            const timeoutMs = isCustom ? 12000 : 8000; // Custom wishlists need more time for LLM design
            const timeout = setTimeout(() => controller.abort(), timeoutMs);

            const res = await fetch('/api/onboarding/configure', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              signal: controller.signal,
              body: JSON.stringify({
                organization: org,
                name: name,
                email: email,
                domain: data.domain,
                governance: data.governance,
                setupId: setupId,
                wishlist: data.wishlist || '',
                inputs: data.inputs || [],
                outputs: data.outputs || [],
                constraints: data.constraints || [],
                website: document.getElementById('honeyField').value, // Honeypot
                _t: _pageLoadTime // Bot timing token
              })
            });

            clearTimeout(timeout);

            if (!res.ok) {
              const errBody = await res.json().catch(() => ({}));
              throw new Error(errBody.error || `HTTP ${res.status}`);
            }

            progressEl.textContent = isCustom ? 'Applying governance constraints...' : 'Building agent pipeline...';
            return await res.json();
          } catch (err) {
            console.warn('[Onboarding] Configure API error:', err.message);
            return null;
          }
        })();

        // Wait for both
        const [, config] = await Promise.all([formspreePromise, configPromise]);

        // Remove progress text
        if (progressEl.parentNode) progressEl.remove();

        // Save to localStorage (includes wishlist for custom pipelines)
        localStorage.setItem('gia_config', JSON.stringify({
          orgName: org,
          userName: name,
          userEmail: email,
          domain: data.domain,
          governance: data.governance,
          setupComplete: true,
          setupDate: data.signup_date,
          setupId: setupId,
          configurationId: config ? config.configurationId : null,
          workforceType: config ? config.workforceMapping.matchedType : null,
          isCustom: config ? config.workforceMapping.isCustom : false,
          pipelineName: config ? config.agentPipeline.name : null,
          pipelineRoles: config ? config.agentPipeline.roles : [],
          wishlist: data.wishlist || null,
          inputs: data.inputs || [],
          outputs: data.outputs || [],
          constraints: data.constraints || []
        }));

        // Show confirmation
        document.getElementById('formCard').querySelector('form').style.display = 'none';
        document.getElementById('runId').textContent = setupId;

        if (config) {
          renderDynamicConfirmation(config);
        } else {
          renderStaticConfirmation();
        }

        document.getElementById('confirmation').classList.add('show');
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Show registration card after confirmation (Phase 2: self-service signup)
        setTimeout(() => showRegistrationCard(), 800);
      } catch (err) {
        // Re-enable button on error (with 3s debounce)
        console.error('[Onboarding] Submission error:', err);
        if (progressEl.parentNode) progressEl.remove();
        errEl.textContent = 'Something went wrong. Please try again.';
        errEl.classList.add('show');
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'Get Started';
          btn.style.opacity = '1';
          _submitting = false;
        }, 3000);
      }
    });

    // ═══════════════════════════════════════════════════════════════
    // REGISTRATION (Phase 2: Self-Service Signup)
    // ═══════════════════════════════════════════════════════════════

    function showRegistrationCard() {
      const card = document.getElementById('registerCard');
      const emailField = document.getElementById('regEmail');

      // Pre-fill email from onboarding form
      const savedEmail = document.getElementById('userEmail').value.trim();
      if (savedEmail) emailField.value = savedEmail;

      card.classList.add('show');
    }

    async function handleRegistration() {
      const btn = document.getElementById('regBtn');
      const errEl = document.getElementById('regError');
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regPasswordConfirm').value;

      // Client-side validation
      errEl.classList.remove('show');

      if (!email || !password || !confirmPassword) {
        errEl.textContent = 'Please fill in all fields.';
        errEl.classList.add('show');
        return;
      }

      if (password !== confirmPassword) {
        errEl.textContent = 'Passwords do not match.';
        errEl.classList.add('show');
        return;
      }

      if (password.length < 8) {
        errEl.textContent = 'Password must be at least 8 characters.';
        errEl.classList.add('show');
        return;
      }

      if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
        errEl.textContent = 'Password must contain at least one letter and one number.';
        errEl.classList.add('show');
        return;
      }

      // Disable button
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      // Gather context from onboarding
      const giaConfig = JSON.parse(localStorage.getItem('gia_config') || '{}');

      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            password: password,
            displayName: document.getElementById('userName').value.trim() || email.split('@')[0],
            organizationName: document.getElementById('orgName').value.trim() || 'My Organization',
            setupId: giaConfig.setupId || giaConfig.configurationId || null,
            domainType: giaConfig.workforceType || null,
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || `Registration failed (${res.status})`);
        }

        // Store auth session via GIA.auth (single source of truth)
        if (window.GIA && window.GIA.auth) {
          window.GIA.auth.setSession(data);
        } else {
          // Fallback if gia-core.js didn't load
          sessionStorage.setItem('gia_token', data.token);
          sessionStorage.setItem('gia_session', JSON.stringify({
            sessionId: data.sessionId,
            user: data.user,
            tenant: data.tenant,
          }));
        }

        // Update gia_config with account info
        const updatedConfig = { ...giaConfig, ...data.user, tenantId: data.tenant.id, registered: true };
        localStorage.setItem('gia_config', JSON.stringify(updatedConfig));

        // Show success
        document.getElementById('regForm').style.display = 'none';
        document.getElementById('regSuccess').classList.add('show');

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = '/console';
        }, 2000);

      } catch (err) {
        errEl.textContent = err.message;
        errEl.classList.add('show');
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }
  </script>
</body>
</html>
