# ACE Governance Platform - Frontend Dockerfile
# Multi-stage build: Vite build → Nginx serve
#
# The frontend is built with VITE_API_SERVER_URL empty so that API calls
# go to the same origin (nginx proxies /api/* to the backend server).
# This keeps the Anthropic API key on the server — never in the browser.

# =============================================================================
# Stage 1: Build the Vite/React application
# =============================================================================
FROM node:20-alpine AS builder

WORKDIR /app

# Copy package files first (better layer caching)
COPY package*.json ./

# Install dependencies
RUN npm install --ignore-scripts

# Copy source code
COPY . .

# Build arg: API server URL (empty = same origin via nginx proxy)
ARG VITE_API_SERVER_URL=""
ENV VITE_API_SERVER_URL=$VITE_API_SERVER_URL

# Disable demo mode in production builds
ENV VITE_DEMO_MODE=false

# Do NOT include VITE_ANTHROPIC_API_KEY — it stays on the server

# Build the Vite application
RUN npm run build

# =============================================================================
# Stage 2: Serve with Nginx
# =============================================================================
FROM nginx:alpine

# Remove default nginx config
RUN rm -rf /etc/nginx/conf.d/default.conf

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy built frontend from builder stage
COPY --from=builder /app/dist /usr/share/nginx/html

# Nginx runs on port 80 (HTTP) and 443 (HTTPS)
EXPOSE 80 443

# Health check (uses dedicated /nginx-health endpoint)
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:80/nginx-health || exit 1

CMD ["nginx", "-g", "daemon off;"]
