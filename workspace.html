<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GIA | Pipeline Workspace</title>
  <meta name="description" content="Execute governed AI pipelines. Upload documents, compile plans, approve gates, download sealed evidence bundles.">
  <link rel="icon" type="image/svg+xml" href="/shared/gia-icon.svg">
  <script src="/shared/gia-core.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --dark: #0a0a0f;
      --dark-lighter: #12121a;
      --gray-900: #18181b;
      --gray-800: #27272a;
      --gray-700: #3f3f46;
      --gray-600: #52525b;
      --gray-500: #71717a;
      --gray-400: #a1a1aa;
      --gray-300: #d4d4d8;
      --white: #ffffff;
      --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 50%, var(--secondary) 100%);
      --err: #ef4444;
      --warn: #f59e0b;
      --gate: #f97316;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark);
      color: var(--white);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── Layout ─────────────────────────────────────── */
    .workspace-header {
      background: var(--dark-lighter);
      border-bottom: 1px solid var(--gray-800);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .workspace-header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .workspace-header .tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: rgba(99,102,241,0.15);
      color: var(--primary-light);
      border: 1px solid rgba(99,102,241,0.3);
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ── Sections ───────────────────────────────────── */
    .section {
      background: var(--gray-900);
      border: 1px solid var(--gray-800);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-400);
      margin-bottom: 1rem;
    }

    /* ── Upload Zone ────────────────────────────────── */
    .upload-zone {
      border: 2px dashed var(--gray-700);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--primary);
      background: rgba(99,102,241,0.05);
    }
    .upload-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .upload-zone p { color: var(--gray-400); font-size: 0.9rem; }
    .upload-zone input[type="file"] { display: none; }

    .file-list { margin-top: 1rem; }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: var(--gray-800);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .file-item .name { color: var(--white); }
    .file-item .size { color: var(--gray-500); font-size: 0.75rem; }
    .file-item .remove { color: var(--err); cursor: pointer; background: none; border: none; font-size: 1rem; }

    /* ── Pipeline Config ────────────────────────────── */
    .config-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .config-row label {
      font-size: 0.8rem;
      color: var(--gray-400);
      display: block;
      margin-bottom: 0.3rem;
    }
    .config-row select, .config-row input {
      width: 100%;
      padding: 0.6rem 0.8rem;
      background: var(--gray-800);
      border: 1px solid var(--gray-700);
      border-radius: 6px;
      color: var(--white);
      font-size: 0.9rem;
      font-family: inherit;
    }

    /* ── Buttons ────────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--gradient-primary);
      color: var(--white);
    }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-approve {
      background: var(--secondary);
      color: var(--white);
    }
    .btn-reject {
      background: var(--err);
      color: var(--white);
    }
    .btn-outline {
      background: transparent;
      color: var(--gray-300);
      border: 1px solid var(--gray-700);
    }
    .btn-group { display: flex; gap: 0.75rem; margin-top: 1rem; }

    /* ── Plan DAG ───────────────────────────────────── */
    .dag-container { display: flex; flex-direction: column; gap: 0.25rem; }
    .dag-node {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--gray-800);
      border-radius: 8px;
      border-left: 3px solid var(--gray-600);
      transition: all 0.3s;
    }
    .dag-node.active { border-left-color: var(--primary); background: rgba(99,102,241,0.1); }
    .dag-node.completed { border-left-color: var(--secondary); }
    .dag-node.failed { border-left-color: var(--err); }
    .dag-node.gate { border-left-color: var(--gate); background: rgba(249,115,22,0.08); }
    .dag-node .step-num {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 700;
      background: var(--gray-700);
      color: var(--gray-300);
      flex-shrink: 0;
    }
    .dag-node.completed .step-num { background: var(--secondary); color: #fff; }
    .dag-node.active .step-num { background: var(--primary); color: #fff; }
    .dag-node.gate .step-num { background: var(--gate); color: #fff; }
    .dag-node .step-info { flex: 1; }
    .dag-node .step-label { font-size: 0.85rem; font-weight: 600; color: var(--white); }
    .dag-node .step-type { font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; }
    .dag-node .step-status { font-size: 0.75rem; color: var(--gray-400); }
    .dag-arrow { text-align: center; color: var(--gray-600); font-size: 0.8rem; }

    /* ── Gate Panel ──────────────────────────────────── */
    .gate-panel {
      background: rgba(249,115,22,0.08);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: 10px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    .gate-panel h3 {
      color: var(--gate);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .gate-panel p { color: var(--gray-300); font-size: 0.85rem; margin-bottom: 0.75rem; }
    .gate-panel textarea {
      width: 100%;
      padding: 0.6rem;
      background: var(--gray-800);
      border: 1px solid var(--gray-700);
      border-radius: 6px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 60px;
    }

    /* ── Results / Evidence ──────────────────────────── */
    .evidence-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(16,185,129,0.08);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 8px;
    }
    .evidence-card .seal-hash {
      font-family: monospace;
      font-size: 0.75rem;
      color: var(--gray-400);
      word-break: break-all;
    }

    /* ── Status Badges ──────────────────────────────── */
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-pending { background: rgba(113,113,122,0.2); color: var(--gray-400); }
    .badge-running { background: rgba(99,102,241,0.2); color: var(--primary-light); }
    .badge-gate { background: rgba(249,115,22,0.2); color: var(--gate); }
    .badge-completed { background: rgba(16,185,129,0.2); color: var(--secondary); }
    .badge-failed { background: rgba(239,68,68,0.2); color: var(--err); }
    .badge-sealed { background: rgba(16,185,129,0.3); color: var(--secondary); }

    /* ── Loading Spinner ────────────────────────────── */
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* ── Caps meter ─────────────────────────────────── */
    .caps-meter { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.75rem; }
    .caps-item { font-size: 0.75rem; color: var(--gray-400); }
    .caps-item strong { color: var(--white); }

    /* ── Worker result summary ──────────────────────── */
    .worker-summary {
      font-size: 0.8rem;
      color: var(--gray-300);
      padding: 0.5rem 0.75rem;
      background: var(--gray-800);
      border-radius: 6px;
      margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .config-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="workspace-header">
    <h1>GIA Pipeline Workspace</h1>
    <span class="tag" id="statusTag">Ready</span>
  </header>

  <div class="container">
    <!-- ═══ PHASE 1: UPLOAD & CONFIG ═══ -->
    <div id="phaseUpload">
      <div class="section">
        <div class="section-title">1. Upload Documents</div>
        <div class="upload-zone" id="uploadZone">
          <div class="icon">+</div>
          <p>Drop files here or click to upload<br><span style="font-size:0.75rem;color:var(--gray-500)">PDF, DOCX, Images, CSV &bull; Max 10MB each</span></p>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.tiff,.txt,.csv">
        </div>
        <div class="file-list" id="fileList"></div>
      </div>

      <div class="section">
        <div class="section-title">2. Pipeline Configuration</div>
        <div class="config-row">
          <div>
            <label>Domain</label>
            <select id="cfgDomain">
              <option value="VA Disability Claims">VA Disability Claims</option>
              <option value="Legal Analysis">Legal Analysis</option>
              <option value="Healthcare Compliance">Healthcare Compliance</option>
              <option value="Financial Audit">Financial Audit</option>
              <option value="General Analysis">General Analysis</option>
            </select>
          </div>
          <div>
            <label>Governance Level</label>
            <select id="cfgGovLevel">
              <option value="Strict">Strict (recommended)</option>
              <option value="Advisory">Advisory</option>
              <option value="Regulated">Regulated</option>
            </select>
          </div>
        </div>
        <div class="config-row">
          <div>
            <label>Case ID (optional)</label>
            <input type="text" id="cfgCaseId" placeholder="e.g. CASE-2026-001">
          </div>
          <div>
            <label>Constraints</label>
            <select id="cfgConstraints" multiple style="min-height:70px">
              <option value="no-pii" selected>No Raw PII</option>
              <option value="human-approval" selected>Human Approval Gates</option>
              <option value="read-only">Read Only</option>
              <option value="no-external-apis">No External APIs</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnCompile" disabled>Compile Pipeline</button>
        </div>
      </div>
    </div>

    <!-- ═══ PHASE 2: PLAN REVIEW ═══ -->
    <div id="phasePlan" class="hidden">
      <div class="section">
        <div class="section-title">Spawn Plan</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
          <div>
            <span class="badge badge-pending" id="planDomainBadge"></span>
            <span style="font-size:0.8rem;color:var(--gray-400);margin-left:0.5rem" id="planHash"></span>
          </div>
          <div class="caps-meter" id="planCaps"></div>
        </div>
        <div class="dag-container" id="dagContainer"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnExecute">Execute Pipeline</button>
          <button class="btn btn-outline" id="btnBack">Back</button>
        </div>
      </div>
    </div>

    <!-- ═══ PHASE 3: EXECUTION ═══ -->
    <div id="phaseExec" class="hidden">
      <div class="section">
        <div class="section-title">Execution Progress</div>
        <div class="dag-container" id="execDag"></div>
        <div class="caps-meter" id="execCaps"></div>
      </div>

      <!-- Gate panel (shown when paused) -->
      <div id="gateSection" class="hidden">
        <div class="gate-panel">
          <h3 id="gateName">Gate Review Required</h3>
          <p id="gateDescription"></p>
          <div id="gateFindings" class="worker-summary" style="margin-bottom:0.75rem"></div>
          <label style="font-size:0.8rem;color:var(--gray-400);display:block;margin-bottom:0.3rem">Rationale (optional)</label>
          <textarea id="gateRationale" placeholder="Enter your review notes..."></textarea>
          <div class="btn-group">
            <button class="btn btn-approve" id="btnApprove">Approve & Continue</button>
            <button class="btn btn-reject" id="btnReject">Reject</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ PHASE 4: RESULTS ═══ -->
    <div id="phaseResults" class="hidden">
      <div class="section">
        <div class="section-title">Pipeline Complete</div>
        <div class="evidence-card">
          <div>
            <div style="font-weight:600;margin-bottom:0.25rem">Sealed Evidence Bundle</div>
            <div class="seal-hash" id="resultSealHash"></div>
          </div>
          <button class="btn btn-primary" id="btnDownload">Download Bundle</button>
        </div>
        <div class="caps-meter" id="resultCaps" style="margin-top:1rem"></div>
        <div id="resultWorkers" style="margin-top:1rem"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-outline" id="btnNewRun">New Pipeline Run</button>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════
    let files = [];
    let currentRunId = null;
    let currentPlan = null;
    let token = null;
    let pollTimer = null;

    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ── Auth ─────────────────────────────────────────────
    function getToken() {
      if (token) return token;
      token = localStorage.getItem('ace_token');
      if (!token) {
        window.location.href = '/login';
        return null;
      }
      return token;
    }

    async function apiFetch(url, options = {}) {
      const t = getToken();
      if (!t) throw new Error('Not authenticated');
      const res = await fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          'Authorization': 'Bearer ' + t,
          ...(!options.body || options.body instanceof FormData ? {} : { 'Content-Type': 'application/json' }),
        },
      });
      if (res.status === 401) { window.location.href = '/login'; throw new Error('Auth expired'); }
      return res;
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 1: UPLOAD
    // ═══════════════════════════════════════════════════════════
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const btnCompile = document.getElementById('btnCompile');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', e => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      addFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => { addFiles(fileInput.files); fileInput.value = ''; });

    function addFiles(newFiles) {
      for (const f of newFiles) {
        if (f.size > 10 * 1024 * 1024) { alert(f.name + ' exceeds 10MB limit'); continue; }
        if (!files.find(x => x.name === f.name && x.size === f.size)) files.push(f);
      }
      renderFiles();
    }

    function removeFile(idx) { files.splice(idx, 1); renderFiles(); }

    function renderFiles() {
      fileList.innerHTML = files.map((f, i) =>
        '<div class="file-item">' +
          '<span class="name">' + esc(f.name) + '</span>' +
          '<span class="size">' + (f.size / 1024).toFixed(0) + ' KB</span>' +
          '<button class="remove" onclick="removeFile(' + i + ')">x</button>' +
        '</div>'
      ).join('');
      btnCompile.disabled = files.length === 0;
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 2: COMPILE
    // ═══════════════════════════════════════════════════════════
    btnCompile.addEventListener('click', async () => {
      btnCompile.disabled = true;
      btnCompile.innerHTML = '<span class="spinner"></span> Compiling...';
      document.getElementById('statusTag').textContent = 'Compiling';

      try {
        // Step 1: Compile the plan (we'll pass doc metadata, upload after)
        const constraints = Array.from(document.getElementById('cfgConstraints').selectedOptions).map(o => o.value);
        const res = await apiFetch('/api/pipeline/compile', {
          method: 'POST',
          body: JSON.stringify({
            pipeline: {
              domain: document.getElementById('cfgDomain').value,
              governanceLevel: document.getElementById('cfgGovLevel').value,
              constraints: constraints,
              roles: [],
              inputs: files.map(f => f.type.split('/')[1] || 'unknown'),
              outputs: ['report'],
            },
            caseId: document.getElementById('cfgCaseId').value || undefined,
            documents: files.map((f, i) => ({
              docId: 'pending-' + i,
              filename: f.name,
              mimeType: f.type || 'application/octet-stream',
              contentHash: 'pending',
              sizeBytes: f.size,
            })),
          }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Compile failed');

        currentRunId = data.runId;
        currentPlan = data.plan;

        // Step 2: Upload actual files
        const formData = new FormData();
        formData.append('runId', currentRunId);
        for (const f of files) formData.append('documents', f);
        await apiFetch('/api/pipeline/upload', { method: 'POST', body: formData });

        // Show plan
        showPlanPhase(data);

      } catch (err) {
        alert('Compile failed: ' + err.message);
        btnCompile.disabled = false;
        btnCompile.textContent = 'Compile Pipeline';
        document.getElementById('statusTag').textContent = 'Ready';
      }
    });

    function showPlanPhase(data) {
      document.getElementById('phaseUpload').classList.add('hidden');
      document.getElementById('phasePlan').classList.remove('hidden');
      document.getElementById('statusTag').textContent = 'Plan Ready';
      document.getElementById('statusTag').className = 'tag';

      document.getElementById('planDomainBadge').textContent = esc(data.plan.domain);
      document.getElementById('planHash').textContent = 'Hash: ' + data.planHash.substring(0, 16) + '...';

      const caps = data.plan.caps;
      document.getElementById('planCaps').innerHTML =
        '<div class="caps-item"><strong>' + caps.maxWorkers + '</strong> workers</div>' +
        '<div class="caps-item"><strong>' + (caps.maxTokens/1000).toFixed(0) + 'K</strong> tokens</div>' +
        '<div class="caps-item"><strong>$' + (caps.maxCostCents/100).toFixed(2) + '</strong> cost cap</div>' +
        '<div class="caps-item"><strong>' + (caps.maxRuntimeMs/1000).toFixed(0) + 's</strong> runtime</div>';

      // Render DAG
      const dag = document.getElementById('dagContainer');
      const gateNodes = new Set(data.plan.gates.map(g => g.afterNode));
      dag.innerHTML = data.plan.nodes.map((n, i) => {
        let html = '<div class="dag-node">' +
          '<div class="step-num">' + (i+1) + '</div>' +
          '<div class="step-info">' +
            '<div class="step-label">' + esc(n.label) + '</div>' +
            '<div class="step-type">' + esc(n.type) + ' &bull; ' + esc(n.maiLevel) + '</div>' +
          '</div></div>';
        if (gateNodes.has(n.id)) {
          const gate = data.plan.gates.find(g => g.afterNode === n.id);
          html += '<div class="dag-node gate">' +
            '<div class="step-num">G</div>' +
            '<div class="step-info">' +
              '<div class="step-label">' + esc(gate.label) + '</div>' +
              '<div class="step-type">MANDATORY GATE</div>' +
            '</div></div>';
        }
        if (i < data.plan.nodes.length - 1) html += '<div class="dag-arrow">|</div>';
        return html;
      }).join('');
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 3: EXECUTE
    // ═══════════════════════════════════════════════════════════
    document.getElementById('btnExecute').addEventListener('click', async () => {
      document.getElementById('phasePlan').classList.add('hidden');
      document.getElementById('phaseExec').classList.remove('hidden');
      document.getElementById('statusTag').textContent = 'Executing';

      try {
        const res = await apiFetch('/api/pipeline/execute', {
          method: 'POST',
          body: JSON.stringify({ runId: currentRunId }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Execution failed');

        handleExecutionResult(data);
      } catch (err) {
        alert('Execution failed: ' + err.message);
      }
    });

    document.getElementById('btnBack').addEventListener('click', () => {
      document.getElementById('phasePlan').classList.add('hidden');
      document.getElementById('phaseUpload').classList.remove('hidden');
      document.getElementById('statusTag').textContent = 'Ready';
      btnCompile.disabled = false;
      btnCompile.textContent = 'Compile Pipeline';
    });

    function handleExecutionResult(data) {
      renderExecDag(data);

      if (data.status === 'paused_at_gate') {
        document.getElementById('statusTag').textContent = 'Gate Review';
        showGatePanel(data);
      } else if (data.status === 'completed') {
        showResults(data);
      } else if (data.status === 'failed') {
        document.getElementById('statusTag').textContent = 'Failed';
        alert('Pipeline failed: ' + (data.error || 'Unknown error'));
      }
    }

    function renderExecDag(data) {
      const dag = document.getElementById('execDag');
      const results = data.workerResults || {};
      const gateNodes = new Set((currentPlan?.gates || []).map(g => g.afterNode));

      dag.innerHTML = currentPlan.nodes.map((n, i) => {
        const wr = results[n.id];
        let cls = '';
        if (wr && wr.status === 'success') cls = 'completed';
        else if (wr && wr.status === 'error') cls = 'failed';
        else if (data.currentNode === n.id) cls = 'active';

        let html = '<div class="dag-node ' + cls + '">' +
          '<div class="step-num">' + (i+1) + '</div>' +
          '<div class="step-info">' +
            '<div class="step-label">' + esc(n.label) + '</div>' +
            '<div class="step-type">' + esc(n.type) +
              (wr ? ' &bull; ' + esc(wr.summary || '').substring(0, 80) : '') +
            '</div>' +
          '</div>' +
          (wr ? '<span class="badge badge-' + (wr.status === 'success' ? 'completed' : 'failed') + '">' + esc(wr.status) + '</span>' : '') +
        '</div>';

        if (gateNodes.has(n.id)) {
          const gate = currentPlan.gates.find(g => g.afterNode === n.id);
          const isActive = data.status === 'paused_at_gate' && data.gateId === gate.id;
          html += '<div class="dag-node ' + (isActive ? 'gate' : (wr ? 'completed' : '')) + '">' +
            '<div class="step-num">G</div>' +
            '<div class="step-info">' +
              '<div class="step-label">' + esc(gate.label) + '</div>' +
              '<div class="step-type">' + (isActive ? 'AWAITING APPROVAL' : 'MANDATORY GATE') + '</div>' +
            '</div></div>';
        }
        if (i < currentPlan.nodes.length - 1) html += '<div class="dag-arrow">|</div>';
        return html;
      }).join('');

      // Caps
      const c = data.capsUsed || {};
      document.getElementById('execCaps').innerHTML =
        '<div class="caps-item"><strong>' + (c.workersSpawned || 0) + '</strong>/' + currentPlan.caps.maxWorkers + ' workers</div>' +
        '<div class="caps-item"><strong>' + ((c.tokens||0)/1000).toFixed(1) + 'K</strong>/' + (currentPlan.caps.maxTokens/1000).toFixed(0) + 'K tokens</div>' +
        '<div class="caps-item"><strong>' + ((c.runtimeMs||0)/1000).toFixed(1) + 's</strong> runtime</div>';
    }

    function showGatePanel(data) {
      document.getElementById('gateSection').classList.remove('hidden');
      const gate = currentPlan.gates.find(g => g.id === data.gateId);
      document.getElementById('gateName').textContent = gate ? gate.label : 'Gate Review';
      document.getElementById('gateDescription').textContent = gate ? gate.description : '';

      // Show latest worker findings
      const lastNode = data.currentNode;
      const wr = data.workerResults?.[lastNode];
      document.getElementById('gateFindings').textContent = wr?.summary || 'No findings available';
    }

    // ── Gate Approve / Reject ────────────────────────────
    document.getElementById('btnApprove').addEventListener('click', () => resolveGate(true));
    document.getElementById('btnReject').addEventListener('click', () => resolveGate(false));

    async function resolveGate(approved) {
      const rationale = document.getElementById('gateRationale').value.trim();
      document.getElementById('gateSection').classList.add('hidden');
      document.getElementById('statusTag').textContent = approved ? 'Resuming' : 'Rejected';

      try {
        const gateId = currentPlan.gates.find(g =>
          document.getElementById('gateName').textContent === g.label
        )?.id;

        const res = await apiFetch('/api/pipeline/' + currentRunId + '/gate/' + gateId + '/resolve', {
          method: 'POST',
          body: JSON.stringify({ approved, rationale }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Gate resolution failed');

        handleExecutionResult(data);
      } catch (err) {
        alert('Gate resolution failed: ' + err.message);
      }
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 4: RESULTS
    // ═══════════════════════════════════════════════════════════
    function showResults(data) {
      document.getElementById('phaseExec').classList.add('hidden');
      document.getElementById('phaseResults').classList.remove('hidden');
      document.getElementById('statusTag').textContent = 'Complete';

      const bundle = data.evidenceBundle || {};
      document.getElementById('resultSealHash').textContent =
        'Seal: ' + (bundle.sealHash || 'N/A') + '\nManifest: ' + (bundle.manifestHash || 'N/A');

      const c = data.capsUsed || {};
      document.getElementById('resultCaps').innerHTML =
        '<div class="caps-item"><strong>' + (c.workersSpawned || 0) + '</strong> workers</div>' +
        '<div class="caps-item"><strong>' + ((c.tokens||0)/1000).toFixed(1) + 'K</strong> tokens</div>' +
        '<div class="caps-item"><strong>$' + ((c.costCents||0)/100).toFixed(2) + '</strong> cost</div>' +
        '<div class="caps-item"><strong>' + ((c.runtimeMs||0)/1000).toFixed(1) + 's</strong> runtime</div>';

      // Worker summaries
      const workers = data.workerResults || {};
      document.getElementById('resultWorkers').innerHTML = Object.entries(workers).map(([id, wr]) =>
        '<div class="worker-summary"><strong>' + esc(id) + '</strong>: ' + esc(wr.summary || '').substring(0, 200) + '</div>'
      ).join('');
    }

    document.getElementById('btnDownload').addEventListener('click', async () => {
      try {
        const res = await apiFetch('/api/pipeline/' + currentRunId + '/evidence');
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'evidence-bundle-' + currentRunId + '.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Download failed: ' + err.message);
      }
    });

    document.getElementById('btnNewRun').addEventListener('click', () => {
      document.getElementById('phaseResults').classList.add('hidden');
      document.getElementById('phaseUpload').classList.remove('hidden');
      document.getElementById('statusTag').textContent = 'Ready';
      files = [];
      renderFiles();
      currentRunId = null;
      currentPlan = null;
      btnCompile.textContent = 'Compile Pipeline';
    });
  </script>
</body>
</html>
