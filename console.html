<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GIA Console | Governed AI Terminal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Brutalist palette - warm dark with amber accent */
      --bg: #0a0a09;
      --bg-secondary: #111110;
      --bg-tertiary: #18181a;
      --border: #262624;
      --border-bright: #3a3a36;
      --text: #a8a8a0;
      --text-dim: #5c5c58;
      --text-bright: #e8e8e4;

      /* Single accent - muted amber/gold */
      --accent: #c9a227;
      --accent-dim: #a68520;
      --accent-bright: #e4b82c;

      /* Semantic - monochrome-ish, not rainbow */
      --ok: #6b8f71;
      --ok-dim: #4a6b4f;
      --warn: #b89c4a;
      --warn-dim: #8a7538;
      --err: #a85454;
      --err-dim: #7a3d3d;
      --info: #6b7f8f;

      /* Legacy aliases for compat */
      --green: var(--ok);
      --green-dim: var(--ok-dim);
      --yellow: var(--warn);
      --red: var(--err);
      --blue: var(--info);
      --cyan: var(--info);
      --orange: var(--accent);
      --pink: var(--accent-dim);
      --accent-dim: var(--accent-dim);

      --font-mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
      --font-sans: 'Inter', -apple-system, sans-serif;

      /* Subtle grain texture */
      --grain: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    /* Subtle grain overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: var(--grain);
      opacity: 0.015;
      pointer-events: none;
      z-index: 9999;
    }

    /* Header - tighter, sharper */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-bright);
      letter-spacing: -0.02em;
    }

    .logo-icon {
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--bg);
    }

    .workflow-tag {
      font-size: 0.7rem;
      color: var(--text-dim);
      background: transparent;
      padding: 0;
      font-family: var(--font-mono);
      letter-spacing: 0.02em;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.65rem;
      padding: 0.2rem 0.5rem;
      border-radius: 2px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .status-pill.running {
      background: transparent;
      color: var(--ok);
      border: 1px solid var(--ok-dim);
    }

    .status-pill.paused {
      background: transparent;
      color: var(--warn);
      border: 1px solid var(--warn-dim);
    }

    .status-dot {
      width: 5px;
      height: 5px;
      border-radius: 1px;
      background: currentColor;
    }

    .status-pill.running .status-dot {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .header-btn {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      padding: 0.3rem 0.5rem;
      border-radius: 2px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.1s;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .header-btn:hover {
      border-color: var(--border-bright);
      color: var(--text);
    }

    .header-btn.danger {
      border-color: var(--err-dim);
      color: var(--err);
    }

    .header-btn.danger:hover {
      background: var(--err-dim);
      color: var(--text-bright);
    }

    .mode-tag {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0.2rem 0.4rem;
      border-radius: 2px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mode-tag.live {
      background: var(--err);
      color: var(--text-bright);
    }

    .cost-tag {
      font-size: 0.65rem;
      font-family: var(--font-mono);
      color: var(--text-dim);
      padding: 0.2rem 0.4rem;
      background: transparent;
      border-radius: 0;
      border: none;
      border-left: 2px solid var(--ok-dim);
      padding-left: 0.5rem;
    }

    .cost-tag.warning {
      color: var(--warn);
      border-left-color: var(--warn);
    }

    .cost-tag.danger {
      color: var(--err);
      border-left-color: var(--err);
    }

    /* Governance Banner - dense, monochrome */
    .governance-banner {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 0.35rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.65rem;
      flex-shrink: 0;
      font-family: var(--font-mono);
    }

    .gov-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-dim);
    }

    .gov-label {
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.55rem;
    }

    .gov-icon {
      display: none; /* Remove emoji icons */
    }

    .gov-divider {
      color: var(--border);
      margin: 0 0.15rem;
      opacity: 0.5;
    }

    /* Metrics Bar - horizontal dense */
    .metrics-bar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.3rem 1rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      font-size: 0.65rem;
      flex-shrink: 0;
      overflow-x: auto;
    }

    .metric-item {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
    }

    .metric-label {
      color: var(--text-dim);
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .metric-value {
      color: var(--text);
      font-family: var(--font-mono);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .compliance-tag {
      margin-left: auto;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }

    .compliance-tag .metric-value {
      color: var(--text-dim);
      font-size: 0.6rem;
    }

    /* Capsule System - sharp, minimal */
    .capsule-block {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: 0;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .capsule-header {
      background: transparent;
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      color: var(--accent);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .capsule-header-left {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .capsule-badge {
      font-size: 0.55rem;
      padding: 0.1rem 0.3rem;
      border-radius: 1px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .capsule-badge.cached {
      background: var(--ok-dim);
      color: var(--text-bright);
    }

    .capsule-badge.new {
      background: var(--accent-dim);
      color: var(--text-bright);
    }

    .capsule-badge.reusable {
      background: var(--info);
      color: var(--text-bright);
    }

    .capsule-content {
      padding: 0.5rem 0.6rem;
      font-size: 0.75rem;
    }

    .capsule-stats {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px solid var(--border);
      font-size: 0.65rem;
      color: var(--text-dim);
    }

    .capsule-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .capsule-stat-value {
      color: var(--text);
      font-weight: 500;
    }

    /* Instruction Pack - sharp, minimal */
    .instruction-pack {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 3px solid var(--warn);
      border-radius: 0;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .instruction-header {
      background: transparent;
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      color: var(--warn);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .instruction-content {
      padding: 0.5rem 0.6rem;
    }

    .instruction-step {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.25rem;
      font-size: 0.75rem;
    }

    .instruction-step-num {
      color: var(--text-dim);
      font-weight: 500;
      min-width: 18px;
      font-size: 0.65rem;
    }

    .instruction-step-text {
      color: var(--text);
    }

    .instruction-step.active .instruction-step-num {
      color: var(--warn);
    }

    .instruction-step.active .instruction-step-text {
      color: var(--text-bright);
    }

    .instruction-step.done .instruction-step-num {
      color: var(--ok-dim);
    }

    .instruction-step.done .instruction-step-text {
      color: var(--text-dim);
      text-decoration: line-through;
    }

    /* Gate Prompt - sharp, urgent */
    .gate-prompt {
      background: var(--bg-secondary);
      border: 1px solid var(--warn);
      border-left: 4px solid var(--warn);
      border-radius: 0;
      padding: 0.75rem;
      margin: 0.75rem 0;
    }

    .gate-prompt-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--warn);
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .gate-prompt-text {
      color: var(--text);
      margin-bottom: 0.75rem;
      line-height: 1.5;
      font-size: 0.8rem;
    }

    .gate-prompt-actions {
      display: flex;
      gap: 0.4rem;
    }

    .gate-btn {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      padding: 0.4rem 0.75rem;
      border-radius: 2px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      transition: all 0.1s;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .gate-btn:hover {
      border-color: var(--border-bright);
    }

    .gate-btn.primary {
      background: var(--ok);
      border-color: var(--ok);
      color: var(--bg);
    }

    .gate-btn.primary:hover {
      background: var(--ok-dim);
    }

    .gate-btn.danger {
      border-color: var(--err-dim);
      color: var(--err);
    }

    .gate-btn.danger:hover {
      background: var(--err-dim);
      color: var(--text-bright);
    }

    /* Evidence Pack Block - sharp, minimal */
    .evidence-block {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-left: 3px solid var(--info);
      border-radius: 0;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .evidence-header {
      background: transparent;
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      color: var(--info);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .evidence-content {
      padding: 0.5rem 0.6rem;
      font-size: 0.75rem;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .evidence-row {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.2rem;
    }

    .evidence-label {
      color: var(--text-dim);
      min-width: 85px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .evidence-value {
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 0.7rem;
    }

    .evidence-pass {
      color: var(--ok);
    }

    .evidence-warn {
      color: var(--warn);
    }

    /* Main Terminal */
    .terminal-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .terminal {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 1rem;
      padding-bottom: 0;
      scroll-behavior: smooth;
    }

    .terminal::-webkit-scrollbar {
      width: 6px;
    }

    .terminal::-webkit-scrollbar-track {
      background: transparent;
    }

    .terminal::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 0;
    }

    /* Terminal Lines */
    .line {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.1rem;
      line-height: 1.5;
      font-size: 0.8rem;
    }

    .line-prefix {
      color: var(--text-dim);
      user-select: none;
      flex-shrink: 0;
      min-width: 18px;
      font-size: 0.75rem;
    }

    .line-content {
      flex: 1;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Line Types - monochrome-ish */
    .line.system .line-prefix { color: var(--text-dim); }
    .line.system .line-content { color: var(--text-dim); }

    .line.step .line-prefix { color: var(--accent); }
    .line.step .line-content { color: var(--text); }

    .line.output .line-prefix { color: var(--text-dim); }
    .line.output .line-content { color: var(--text-dim); }

    .line.success .line-prefix { color: var(--ok); }
    .line.success .line-content { color: var(--ok); }

    .line.warning .line-prefix { color: var(--warn); }
    .line.warning .line-content { color: var(--warn); }

    .line.error .line-prefix { color: var(--err); }
    .line.error .line-content { color: var(--err); }

    .line.gate .line-prefix { color: var(--info); }
    .line.gate .line-content { color: var(--text); }

    .line.human .line-prefix { color: var(--accent); }
    .line.human .line-content { color: var(--text-bright); font-weight: 500; }

    .line.ai .line-prefix { color: var(--text-dim); }
    .line.ai .line-content { color: var(--text); }

    /* Highlights - monochrome semantic */
    .hl-green { color: var(--ok); }
    .hl-yellow { color: var(--warn); }
    .hl-red { color: var(--err); }
    .hl-blue { color: var(--info); }
    .hl-cyan { color: var(--text); }
    .hl-accent { color: var(--accent); }
    .hl-accent { color: var(--accent); }
    .hl-orange { color: var(--accent); }
    .hl-dim { color: var(--text-dim); }
    .hl-bright { color: var(--text-bright); font-weight: 500; }

    /* Blocks - sharp, code-like */
    .block {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 0;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .block-header {
      background: var(--bg);
      padding: 0.35rem 0.6rem;
      font-size: 0.65rem;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .block-content {
      padding: 0.5rem 0.6rem;
      font-size: 0.75rem;
    }

    .block-content pre {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    /* Evidence Badge */
    .evidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: transparent;
      color: var(--info);
      font-size: 0.6rem;
      padding: 0.1rem 0.3rem;
      border-radius: 1px;
      margin-left: 0.4rem;
      border: 1px solid var(--info);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    /* Progress Indicator */
    .progress-line {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      padding: 0.4rem 0.6rem;
      background: var(--bg-secondary);
      border-radius: 0;
      border: 1px solid var(--border);
    }

    .progress-bar {
      flex: 1;
      height: 2px;
      background: var(--border);
      border-radius: 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.65rem;
      color: var(--text-dim);
      white-space: nowrap;
    }

    /* Typing Cursor */
    .cursor {
      display: inline-block;
      width: 7px;
      height: 1em;
      background: var(--accent);
      margin-left: 1px;
      animation: cursor-blink 1s step-end infinite;
      vertical-align: text-bottom;
    }

    @keyframes cursor-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Spacer */
    .spacer {
      height: 0.5rem;
    }

    /* Input Area - minimal */
    .input-area {
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 0.6rem 1rem;
      flex-shrink: 0;
    }

    .input-row {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .input-prefix {
      color: var(--accent);
      font-weight: 500;
      padding-top: 0.5rem;
      user-select: none;
      font-size: 0.8rem;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .input-field {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 0.5rem 0.6rem;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-bright);
      resize: none;
      min-height: 36px;
      max-height: 180px;
      line-height: 1.5;
      transition: border-color 0.1s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent);
    }

    .input-field::placeholder {
      color: var(--text-dim);
    }

    .input-hint {
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .input-hint kbd {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 0.05rem 0.3rem;
      border-radius: 1px;
      font-size: 0.55rem;
    }

    /* Governance Sidebar (collapsible) - sharp, minimal */
    .sidebar-toggle {
      position: fixed;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 72px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-right: none;
      border-radius: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.15s;
      z-index: 100;
    }

    .sidebar-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--text);
      border-color: var(--border-bright);
    }

    .sidebar-toggle.open {
      right: 260px;
    }

    .sidebar {
      position: fixed;
      right: -260px;
      top: 0;
      bottom: 0;
      width: 260px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      padding: 0.75rem;
      transition: right 0.2s ease;
      z-index: 99;
      overflow-y: auto;
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-section {
      margin-bottom: 1.25rem;
    }

    .sidebar-title {
      font-size: 0.55rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0;
      background: transparent;
      border-radius: 0;
      margin-bottom: 0;
      font-size: 0.7rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-item:last-child {
      border-bottom: none;
    }

    .sidebar-item-icon {
      width: 14px;
      height: 14px;
      border-radius: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      flex-shrink: 0;
    }

    .sidebar-item-icon.pass { background: var(--ok-dim); color: var(--text-bright); }
    .sidebar-item-icon.pending { background: var(--border); color: var(--text-dim); }
    .sidebar-item-icon.fail { background: var(--err-dim); color: var(--text-bright); }

    .mai-tag {
      font-size: 0.55rem;
      font-weight: 600;
      padding: 0.15rem 0.3rem;
      border-radius: 1px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .mai-tag.advisory { background: var(--warn-dim); color: var(--text-bright); }
    .mai-tag.mandatory { background: var(--err-dim); color: var(--text-bright); }
    .mai-tag.informational { background: var(--info); color: var(--text-bright); }

    /* Sidebar Export Buttons */
    .sidebar-export-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
      padding: 0.4rem 0.5rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 2px;
      margin-bottom: 0.35rem;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.1s;
    }

    .sidebar-export-btn:hover {
      border-color: var(--accent);
      color: var(--text-bright);
    }

    .sidebar-export-btn:active {
      background: var(--bg-tertiary);
    }

    .sidebar-export-btn .export-format {
      margin-left: auto;
      font-size: 0.55rem;
      color: var(--text-dim);
      background: transparent;
      padding: 0;
    }

    .sidebar-export-btn:hover .export-format {
      color: var(--accent);
    }

    /* Mobile */
    @media (max-width: 600px) {
      .workflow-tag { display: none; }
      .header-btn span { display: none; }
      .terminal { padding: 0.75rem 1rem; }
      .input-area { padding: 0.75rem 1rem; }
      .sidebar-toggle { display: none; }
    }

    /* Demo Banner - subtle */
    .demo-banner {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 0.25rem 1rem;
      text-align: center;
      font-size: 0.6rem;
      color: var(--text-dim);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .demo-banner a {
      color: var(--accent);
    }

    /* Capsule Tooltip */
    .capsule-tooltip {
      position: absolute;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 0.5rem;
      font-size: 0.65rem;
      z-index: 1000;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      display: none;
    }

    .capsule-tooltip-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.2rem;
      color: var(--text-dim);
    }

    .capsule-tooltip-row span:last-child {
      color: var(--text);
      font-family: var(--font-mono);
    }

    .capsule-block:hover .capsule-tooltip {
      display: block;
    }

    /* Evidence Modal - sharp */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 0;
      width: 90%;
      max-width: 640px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
    }

    .modal-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-content {
      padding: 1rem;
      overflow-y: auto;
      font-size: 0.75rem;
    }

    .modal-section {
      margin-bottom: 1rem;
    }

    .modal-section-title {
      font-size: 0.55rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-section-title::after {
      display: none;
    }

    .modal-row {
      display: flex;
      gap: 0.75rem;
      padding: 0.3rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.7rem;
    }

    .modal-row:last-child {
      border-bottom: none;
    }

    .modal-label {
      color: var(--text-dim);
      min-width: 100px;
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .modal-value {
      color: var(--text);
      font-family: var(--font-mono);
    }

    .modal-value.pass {
      color: var(--ok);
    }

    .modal-value.hash {
      color: var(--text-dim);
      font-size: 0.65rem;
    }

    .modal-capsules {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .modal-capsule {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 0.35rem 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-capsule-name {
      color: var(--accent);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .modal-capsule-status {
      font-size: 0.6rem;
      padding: 0.1rem 0.25rem;
      border-radius: 1px;
      background: var(--ok-dim);
      color: var(--text-bright);
    }

    /* Confidence/Drift indicators */
    .gov-item .indicator-drift-warn {
      color: var(--warn);
      animation: drift-pulse 2s infinite;
    }

    @keyframes drift-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>

  <!-- Demo Banner (shown on Vercel/production) -->
  <div class="demo-banner" id="demoBanner" style="display: none;">
    DEMO MODE — No live external calls. Synthetic data only. <a href="/onboarding" style="color: var(--cyan); margin-left: 0.5rem;">Request live access →</a>
  </div>

  <!-- Evidence Pack Modal -->
  <div class="modal-overlay" id="evidenceModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Evidence Pack Viewer</span>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-content">
        <div class="modal-section">
          <div class="modal-section-title">Run Metadata</div>
          <div class="modal-row"><span class="modal-label">Workflow ID</span><span class="modal-value">WF-2026-0204-BD-001</span></div>
          <div class="modal-row"><span class="modal-label">Operator</span><span class="modal-value" id="modalOperator">--</span></div>
          <div class="modal-row"><span class="modal-label">Mode</span><span class="modal-value">DEMO (synthetic)</span></div>
          <div class="modal-row"><span class="modal-label">Started</span><span class="modal-value" id="modalStartTime">--</span></div>
          <div class="modal-row"><span class="modal-label">Duration</span><span class="modal-value" id="modalDuration">--</span></div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Sources & Hashes</div>
          <div class="modal-row"><span class="modal-label">Primary Source</span><span class="modal-value">SAM.gov API (sandbox)</span></div>
          <div class="modal-row"><span class="modal-label">Query Hash</span><span class="modal-value hash">sha256:9f3a7c2d...e8b1</span></div>
          <div class="modal-row"><span class="modal-label">Response Hash</span><span class="modal-value hash">sha256:4a2f8b1c...d9e3</span></div>
          <div class="modal-row"><span class="modal-label">Evidence Sealed</span><span class="modal-value pass">VERIFIED</span></div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Capsule Reuse Log</div>
          <div class="modal-capsules" id="modalCapsules">
            <div class="modal-capsule">
              <span class="modal-capsule-name">NAICS-541512-RANKING</span>
              <span class="modal-capsule-status">HIT - $0.12 saved</span>
            </div>
            <div class="modal-capsule">
              <span class="modal-capsule-name">AFRL-WIN-THEMES</span>
              <span class="modal-capsule-status">HIT - $0.08 saved</span>
            </div>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Gate Approvals</div>
          <div class="modal-row"><span class="modal-label">Gate 1</span><span class="modal-value pass">Domain Authorization [OK]</span></div>
          <div class="modal-row"><span class="modal-label">Gate 2</span><span class="modal-value pass">MAI Classification [OK]</span></div>
          <div class="modal-row"><span class="modal-label">Gate 3</span><span class="modal-value pass">Cost Budget [OK]</span></div>
          <div class="modal-row"><span class="modal-label">Gate 4</span><span class="modal-value" id="modalGate4">Pending...</span></div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Exported Artifacts</div>
          <div class="modal-row"><span class="modal-label">capture-plan.pdf</span><span class="modal-value">demo/artifacts/[hash].pdf</span></div>
          <div class="modal-row"><span class="modal-label">competitive-matrix.xlsx</span><span class="modal-value">demo/artifacts/[hash].xlsx</span></div>
          <div class="modal-row"><span class="modal-label">action-tracker.csv</span><span class="modal-value">demo/artifacts/[hash].csv</span></div>
          <div class="modal-row"><span class="modal-label">evidence-pack.json</span><span class="modal-value">demo/artifacts/[hash].json</span></div>
        </div>

        <div class="modal-section" id="storageWarning" style="background: var(--bg); border: 1px solid var(--border); border-left: 3px solid var(--warn); padding: 0.5rem 0.6rem; margin-top: 0.75rem;">
          <div style="color: var(--warn); font-size: 0.6rem; font-weight: 600; margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.04em;">LOCAL DEMO STORAGE</div>
          <div style="color: var(--text-dim); font-size: 0.65rem; line-height: 1.4;">
            Evidence stored client-side (localStorage). Not tamper-resistant.<br>
            Backend sealing with server-side timestamps required for production.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">G</div>
        <span>GIA</span>
      </div>
      <div class="workflow-tag" id="workflowTag">WF-2026-0204-BD-001</div>
      <div class="status-pill running" id="statusPill">
        <span class="status-dot"></span>
        <span id="statusText">running</span>
      </div>
      <div class="mode-tag" id="modeTag">DEMO</div>
      <button class="header-btn" id="evidenceBtn" title="View Evidence Pack">EVD</button>
    </div>
    <div class="header-right">
      <div class="cost-tag" id="costTag">$0.00</div>
      <button class="header-btn" id="pauseBtn">PAUSE</button>
      <button class="header-btn danger" id="abortBtn">ABORT</button>
      <button class="header-btn" id="helpBtn" title="Keyboard shortcuts">?</button>
    </div>
  </header>

  <!-- Governance Banner -->
  <div class="governance-banner" id="governanceBanner">
    <span class="gov-item"><span class="gov-label">MAI</span> <span class="hl-yellow">ADVISORY</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">ECV</span> <span class="hl-green">ON</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">GATE</span> <span class="hl-cyan">REQ</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">RISK</span> <span class="hl-yellow" id="riskLevel">MED</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">INT</span> <span class="hl-green" id="integrityStatus">OK</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">AUTO</span> <span class="hl-cyan" id="autonomyLevel">ASSIST</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">CONF</span> <span class="hl-green" id="confidenceLevel">HIGH</span></span>
    <span class="gov-divider">/</span>
    <span class="gov-item"><span class="gov-label">DRIFT</span> <span class="hl-green" id="driftStatus">CLEAN</span></span>
  </div>

  <!-- Metrics Bar -->
  <div class="metrics-bar" id="metricsBar">
    <span class="metric-item">
      <span class="metric-label">Time to Decision</span>
      <span class="metric-value" id="timeMetric">00:00</span>
    </span>
    <span class="metric-item">
      <span class="metric-label">API Calls</span>
      <span class="metric-value" id="apiCallsMetric">0</span>
    </span>
    <span class="metric-item">
      <span class="metric-label">Gates Passed</span>
      <span class="metric-value" id="gatesMetric">0/0</span>
    </span>
    <span class="metric-item">
      <span class="metric-label">Interrupts</span>
      <span class="metric-value" id="interruptsMetric">0</span>
    </span>
    <span class="metric-item">
      <span class="metric-label">Capsule Hits</span>
      <span class="metric-value" id="capsuleHitsMetric" style="color: var(--pink);">0</span>
    </span>
    <span class="metric-item compliance-tag">
      <span class="metric-label">Compliance</span>
      <span class="metric-value">FAR · NIST 800-53</span>
    </span>
  </div>

  <!-- Terminal -->
  <div class="terminal-container">
    <div class="terminal" id="terminal"></div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-row">
        <span class="input-prefix">you:</span>
        <div class="input-wrapper">
          <textarea
            class="input-field"
            id="inputField"
            placeholder="interrupt, re-scope, or add constraints..."
            rows="1"
          ></textarea>
        </div>
      </div>
      <div class="input-hint">
        <span><kbd>Enter</kbd> send</span>
        <span><kbd>Esc</kbd> clear</span>
        <span class="hl-dim">|</span>
        <span style="color: var(--green);">● input always active</span>
      </div>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <div class="sidebar-toggle" id="sidebarToggle">
    <span style="font-size: 0.5rem; font-weight: 600; letter-spacing: 0.06em;">GOV</span>
    <span style="font-size: 0.7rem;">&lt;</span>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Governance Status</div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
        <span style="font-size: 0.8rem;">MAI Classification:</span>
        <span class="mai-tag advisory">ADVISORY</span>
      </div>
      <div class="sidebar-item">
        <div class="sidebar-item-icon pass">+</div>
        <span>Domain authorized</span>
      </div>
      <div class="sidebar-item">
        <div class="sidebar-item-icon pass">+</div>
        <span>Cost: $0.14 / $5.00</span>
      </div>
      <div class="sidebar-item">
        <div class="sidebar-item-icon pass">+</div>
        <span>Data classification</span>
      </div>
      <div class="sidebar-item">
        <div class="sidebar-item-icon pending">-</div>
        <span style="color: var(--text-dim);">Output review</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Evidence Pack</div>
      <div class="sidebar-item">
        <span style="color: var(--text-dim); font-size: 0.6rem;">CAP</span>
        <span>3 screenshots</span>
      </div>
      <div class="sidebar-item">
        <span style="color: var(--text-dim); font-size: 0.6rem;">API</span>
        <span>2 calls logged</span>
      </div>
      <div class="sidebar-item">
        <span style="color: var(--text-dim); font-size: 0.6rem;">INT</span>
        <span>0 interrupts</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Run Info</div>
      <div style="font-size: 0.75rem; color: var(--text-dim); line-height: 1.8;">
        <div><span class="hl-dim">ID:</span> GIA-2026-0204-1547</div>
        <div><span class="hl-dim">Domain:</span> BD Capture</div>
        <div><span class="hl-dim">Operator:</span> <span id="sidebarOperator">--</span></div>
        <div><span class="hl-dim">Started:</span> 15:47:22</div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Export</div>
      <button class="sidebar-export-btn" id="exportEvidenceBtn" title="Export evidence pack as JSON">
        <span>Evidence</span>
        <span class="export-format">.json</span>
      </button>
      <button class="sidebar-export-btn" id="exportCapsulesBtn" title="Export capsules as JSON">
        <span>Capsules</span>
        <span class="export-format">.json</span>
      </button>
      <button class="sidebar-export-btn" id="exportFullBtn" title="Export full audit bundle">
        <span>Full Bundle</span>
        <span class="export-format">.json</span>
      </button>
      <div style="font-size: 0.55rem; color: var(--text-dim); margin-top: 0.35rem; line-height: 1.3; text-transform: uppercase; letter-spacing: 0.03em;">
        Local demo storage only
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // GIA RUNTIME CONFIG - SINGLE SOURCE OF TRUTH
    // ============================================
    // This object is FROZEN - cannot be modified at runtime
    const GIA = Object.freeze({
      // Environment detection
      isVercel: window.location.hostname.includes('vercel.app') ||
                window.location.hostname.includes('.vercel.') ||
                window.location.hostname.includes('va-governance'),
      isLocalhost: window.location.hostname === 'localhost' ||
                   window.location.hostname === '127.0.0.1',

      // DEMO MODE: Always true on Vercel, configurable locally
      // To test live mode locally, set FORCE_DEMO = false AND be on localhost
      FORCE_DEMO: true,

      // Computed demo state - CANNOT BE BYPASSED
      get isDemoMode() {
        // If on Vercel, ALWAYS demo - no override possible
        if (this.isVercel) return true;
        // If FORCE_DEMO is true, demo mode
        if (this.FORCE_DEMO) return true;
        // Only allow live mode on localhost with FORCE_DEMO=false
        return false;
      },

      // Storage mode indicator for UI
      get storageMode() {
        return this.isDemoMode ? 'LOCAL_DEMO' : 'BACKEND';
      },

      // Redaction mode for public demos - masks PII
      REDACT_PII: true,

      // Redacted values for public display - NO PII in hashes
      redact: {
        operatorToken: 'DEMO_OPERATOR', // Anonymous token, not email
        operatorDisplay: 'demo-user@███████',
        runIdPrefix: 'DEMO',
        domain: 'BD Capture (Demo)',
      },

      // Guard function - call before ANY execution path
      // This is the SINGLE enforcement point for demo mode
      guardExecution(actionName) {
        if (this.isDemoMode) {
          console.log(`[GIA Guard] Blocked "${actionName}" - DEMO mode active`);
          return false; // Block execution
        }
        return true; // Allow execution
      },

      // Canonical JSON stringify - stable key order for deterministic hashing
      canonicalize(obj) {
        if (obj === null || typeof obj !== 'object') {
          return JSON.stringify(obj);
        }
        if (Array.isArray(obj)) {
          return '[' + obj.map(item => this.canonicalize(item)).join(',') + ']';
        }
        // Sort keys alphabetically for deterministic output
        const sortedKeys = Object.keys(obj).sort();
        const pairs = sortedKeys.map(key => {
          const value = this.canonicalize(obj[key]);
          return JSON.stringify(key) + ':' + value;
        });
        return '{' + pairs.join(',') + '}';
      },

      // Cryptographically secure hash generation with canonical JSON
      async generateHash(data) {
        const encoder = new TextEncoder();
        // Use canonical JSON for deterministic hashing
        const canonical = typeof data === 'string' ? data : this.canonicalize(data);
        const dataBuffer = encoder.encode(canonical);
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      },

      // Generate truncated hash for display (first 8 + last 4 chars)
      async generateDisplayHash(data) {
        const fullHash = await this.generateHash(data);
        return `sha256:${fullHash.slice(0, 8)}...${fullHash.slice(-4)}`;
      },

      // Generate collision-safe workflow ID with crypto entropy
      generateWorkflowId(prefix = 'WF') {
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const timeStr = now.toISOString().slice(11, 19).replace(/:/g, '');
        // Add 6 chars of crypto-random entropy to prevent collisions
        const entropy = new Uint8Array(3);
        crypto.getRandomValues(entropy);
        const entropyHex = Array.from(entropy).map(b => b.toString(16).padStart(2, '0')).join('');
        return `${prefix}-${dateStr}-${timeStr}-${entropyHex.toUpperCase()}`;
      },

      // Safe fetch wrapper - blocks real API calls in demo mode
      // ALL network calls MUST go through this guard
      async safeFetch(url, options = {}) {
        if (this.isDemoMode) {
          console.warn(`[GIA] Blocked fetch to ${url} - DEMO mode`);
          return { ok: false, status: 0, statusText: 'DEMO_MODE_BLOCKED' };
        }
        return fetch(url, options);
      },

      // Evidence capture - stores evidence pack structure
      // NOTE: localStorage is client-side and NOT tamper-resistant
      // Production requires backend sealing with server-side timestamps
      evidence: {
        packs: [],
        hashChain: null, // Append-only hash chain for tamper evidence

        create(workflowId, source, endpoint) {
          const pack = {
            id: `EVD-${Date.now().toString(36).toUpperCase()}`,
            workflowId,
            source,
            endpoint,
            timestamp: new Date().toISOString(),
            queryHash: null,
            responseHash: null,
            packHash: null,
            prevChainHash: this.hashChain,
            validation: 'PENDING',
            negativeAssurance: null,
            sealed: false,
            storageMode: GIA.storageMode // Explicitly mark as LOCAL_DEMO
          };
          this.packs.push(pack);
          return pack;
        },

        async seal(packId, queryData, responseData) {
          const pack = this.packs.find(p => p.id === packId);
          if (!pack) return null;

          // Generate separate hashes for query and response (canonical)
          pack.queryHash = await GIA.generateDisplayHash(queryData);
          pack.responseHash = await GIA.generateDisplayHash(responseData);

          // Generate pack hash including metadata + content hashes
          const packContent = {
            id: pack.id,
            workflowId: pack.workflowId,
            source: pack.source,
            endpoint: pack.endpoint,
            timestamp: pack.timestamp,
            queryHash: pack.queryHash,
            responseHash: pack.responseHash,
            prevChainHash: pack.prevChainHash
          };
          pack.packHash = await GIA.generateDisplayHash(packContent);

          // Update hash chain (append-only)
          this.hashChain = pack.packHash;

          pack.validation = 'VERIFIED';
          pack.sealed = true;
          pack.sealedAt = new Date().toISOString();

          // Persist to localStorage in demo mode
          // WARNING: This is client-side storage - not tamper-resistant
          if (GIA.isDemoMode) {
            try {
              const stored = JSON.parse(localStorage.getItem('gia_evidence') || '[]');
              stored.push(pack);
              localStorage.setItem('gia_evidence', JSON.stringify(stored.slice(-50)));
              localStorage.setItem('gia_hash_chain', this.hashChain);
            } catch (e) {
              console.warn('[GIA] Evidence storage failed:', e);
            }
          }

          return pack;
        },

        // Verify hash chain integrity (demo only - shows the model)
        async verifyChain() {
          let prevHash = null;
          for (const pack of this.packs) {
            if (pack.sealed && pack.prevChainHash !== prevHash) {
              return { valid: false, brokenAt: pack.id };
            }
            prevHash = pack.packHash;
          }
          return { valid: true, chainLength: this.packs.length };
        }
      },

      // Capsule storage - institutional memory
      // NOTE: localStorage is client-side and NOT tamper-resistant
      capsules: {
        cache: new Map(),

        async store(capsuleId, data) {
          // Hash the canonical data for deterministic provenance
          const canonicalData = { ...data };
          delete canonicalData.inputHash; // Don't include hash in hash

          const capsule = {
            id: capsuleId,
            ...data,
            inputHash: await GIA.generateDisplayHash(canonicalData),
            storedAt: new Date().toISOString(),
            version: data.version || 'v1.0.0',
            ttl: data.ttl || '30d',
            lastValidated: new Date().toISOString(),
            storageMode: GIA.storageMode // Explicitly mark as LOCAL_DEMO
          };
          this.cache.set(capsuleId, capsule);

          // Persist to localStorage (demo only)
          if (GIA.isDemoMode) {
            try {
              const stored = JSON.parse(localStorage.getItem('gia_capsules') || '{}');
              stored[capsuleId] = capsule;
              localStorage.setItem('gia_capsules', JSON.stringify(stored));
            } catch (e) {
              console.warn('[GIA] Capsule storage failed:', e);
            }
          }

          return capsule;
        },

        get(capsuleId) {
          // Check memory first
          if (this.cache.has(capsuleId)) {
            return this.cache.get(capsuleId);
          }

          // Check localStorage
          try {
            const stored = JSON.parse(localStorage.getItem('gia_capsules') || '{}');
            if (stored[capsuleId]) {
              this.cache.set(capsuleId, stored[capsuleId]);
              return stored[capsuleId];
            }
          } catch (e) {
            console.warn('[GIA] Capsule retrieval failed:', e);
          }

          return null;
        },

        invalidate(capsuleId, reason = 'POLICY_DRIFT') {
          const capsule = this.get(capsuleId);
          if (capsule) {
            capsule.invalidated = true;
            capsule.invalidatedAt = new Date().toISOString();
            capsule.invalidationReason = reason;
            this.cache.set(capsuleId, capsule);

            // Persist invalidation
            if (GIA.isDemoMode) {
              try {
                const stored = JSON.parse(localStorage.getItem('gia_capsules') || '{}');
                stored[capsuleId] = capsule;
                localStorage.setItem('gia_capsules', JSON.stringify(stored));
              } catch (e) {
                console.warn('[GIA] Capsule invalidation storage failed:', e);
              }
            }
          }
          return capsule;
        }
      }
    });

    // Make GIA globally accessible but immutable
    window.GIA = GIA;

    // Log runtime config
    console.log('[GIA] Runtime Config:', {
      isVercel: GIA.isVercel,
      isLocalhost: GIA.isLocalhost,
      isDemoMode: GIA.isDemoMode,
      redactPII: GIA.REDACT_PII
    });

    // Legacy aliases for backward compatibility
    const IS_DEMO_MODE = GIA.isDemoMode;
    const FORCE_DEMO = GIA.FORCE_DEMO;

    const terminal = document.getElementById('terminal');
    const inputField = document.getElementById('inputField');
    const statusPill = document.getElementById('statusPill');
    const statusText = document.getElementById('statusText');
    const pauseBtn = document.getElementById('pauseBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');

    let isPaused = false;
    let interruptCount = 0;
    let currentCost = 0;
    let apiCalls = 0;
    let gatesPassed = 0;
    let totalGates = 4;
    let startTime = Date.now();

    const costTag = document.getElementById('costTag');
    const timeMetric = document.getElementById('timeMetric');
    const apiCallsMetric = document.getElementById('apiCallsMetric');
    const gatesMetric = document.getElementById('gatesMetric');
    const interruptsMetric = document.getElementById('interruptsMetric');
    const integrityStatus = document.getElementById('integrityStatus');
    const riskLevel = document.getElementById('riskLevel');
    const capsuleHitsMetric = document.getElementById('capsuleHitsMetric');
    const confidenceLevel = document.getElementById('confidenceLevel');
    const driftStatus = document.getElementById('driftStatus');
    let capsuleHits = 0;

    // Generate real workflow ID on load
    const currentWorkflowId = GIA.generateWorkflowId('WF');
    document.getElementById('workflowTag').textContent = currentWorkflowId;

    // Show demo banner if in demo mode
    if (IS_DEMO_MODE) {
      document.getElementById('demoBanner').style.display = 'block';
      document.getElementById('modeTag').textContent = 'DEMO';
      document.getElementById('modeTag').classList.remove('live');
    }

    // Apply PII redaction for public demos
    // In production, ALWAYS redact - no fallback to real data
    function applyRedaction() {
      // Always use redacted values in demo mode (which is always true on Vercel)
      const operatorDisplay = GIA.redact.operatorDisplay;

      // Update sidebar
      const sidebarOp = document.getElementById('sidebarOperator');
      if (sidebarOp) sidebarOp.textContent = operatorDisplay;

      // Update modal
      const modalOp = document.getElementById('modalOperator');
      if (modalOp) modalOp.textContent = operatorDisplay;
    }

    // Apply redaction on load
    applyRedaction();

    // Evidence Modal
    const evidenceModal = document.getElementById('evidenceModal');
    const evidenceBtn = document.getElementById('evidenceBtn');
    const modalClose = document.getElementById('modalClose');

    evidenceBtn.addEventListener('click', () => {
      // Update modal with current data
      document.getElementById('modalStartTime').textContent = new Date(startTime).toISOString().replace('T', ' ').substr(0, 19);
      document.getElementById('modalDuration').textContent = timeMetric.textContent;
      document.getElementById('modalGate4').textContent = gatesPassed >= 4 ? 'Export Approved [OK]' : 'Pending...';
      document.getElementById('modalGate4').className = gatesPassed >= 4 ? 'modal-value pass' : 'modal-value';
      evidenceModal.classList.add('open');
    });

    modalClose.addEventListener('click', () => {
      evidenceModal.classList.remove('open');
    });

    evidenceModal.addEventListener('click', (e) => {
      if (e.target === evidenceModal) {
        evidenceModal.classList.remove('open');
      }
    });

    // Confidence and Drift functions
    function setConfidence(level) {
      confidenceLevel.textContent = level;
      if (level === 'HIGH') {
        confidenceLevel.className = 'hl-green';
      } else if (level === 'MEDIUM') {
        confidenceLevel.className = 'hl-yellow';
      } else if (level === 'LOW') {
        confidenceLevel.className = 'hl-red';
      }
    }

    function setDrift(status) {
      driftStatus.textContent = status;
      if (status === 'CLEAN') {
        driftStatus.className = 'hl-green';
      } else if (status === 'POLICY CHANGED') {
        driftStatus.className = 'indicator-drift-warn';
      } else if (status === 'INVALIDATED') {
        driftStatus.className = 'hl-red';
      }
    }

    // Update timer every second
    setInterval(() => {
      if (statusText.textContent === 'running' || statusText.textContent === 'processing') {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        timeMetric.textContent = `${mins}:${secs}`;
      }
    }, 1000);

    function updateApiCalls() {
      apiCalls++;
      apiCallsMetric.textContent = apiCalls;
    }

    function updateGates(passed) {
      gatesPassed = passed;
      gatesMetric.textContent = `${gatesPassed}/${totalGates}`;
      gatesMetric.style.color = gatesPassed === totalGates ? 'var(--green)' : 'var(--text-bright)';
    }

    function updateInterrupts() {
      interruptsMetric.textContent = interruptCount;
      if (interruptCount > 0) {
        interruptsMetric.style.color = 'var(--orange)';
      }
    }

    function setIntegrity(status) {
      integrityStatus.textContent = status;
      if (status === 'VERIFIED') {
        integrityStatus.className = 'hl-green';
      } else if (status === 'DRIFT ⚠️') {
        integrityStatus.className = 'hl-red';
      }
    }

    function setRisk(level) {
      riskLevel.textContent = level;
      if (level === 'LOW') riskLevel.className = 'hl-green';
      else if (level === 'MODERATE') riskLevel.className = 'hl-yellow';
      else if (level === 'HIGH') riskLevel.className = 'hl-red';
    }

    function updateCost(amount) {
      currentCost += amount;
      costTag.textContent = '$' + currentCost.toFixed(2);
      if (currentCost > 1) {
        costTag.className = 'cost-tag warning';
      }
      if (currentCost > 4) {
        costTag.className = 'cost-tag danger';
      }
    }

    function addEvidencePack(packId, data) {
      const block = document.createElement('div');
      block.className = 'evidence-block';
      block.innerHTML = `
        <div class="evidence-header">EVD ${packId}</div>
        <div class="evidence-content">
          <div class="evidence-row"><span class="evidence-label">Source</span><span class="evidence-value">${data.source}</span></div>
          <div class="evidence-row"><span class="evidence-label">Endpoint</span><span class="evidence-value">${data.endpoint}</span></div>
          <div class="evidence-row"><span class="evidence-label">Query Hash</span><span class="evidence-value">${data.queryHash}</span></div>
          <div class="evidence-row"><span class="evidence-label">Timestamp</span><span class="evidence-value">${data.timestamp}</span></div>
          <div class="evidence-row"><span class="evidence-label">Validation</span><span class="evidence-value evidence-pass">${data.validation}</span></div>
          ${data.negativeAssurance ? `<div class="evidence-row"><span class="evidence-label">Note</span><span class="evidence-value evidence-warn">${data.negativeAssurance}</span></div>` : ''}
        </div>
      `;
      terminal.appendChild(block);
      scrollToBottom();
    }

    async function addCapsule(capsuleId, data) {
      const block = document.createElement('div');
      block.className = 'capsule-block';
      block.style.position = 'relative';

      // Store capsule and get provenance data
      const storedCapsule = await GIA.capsules.store(capsuleId, data);
      const packVersion = storedCapsule.version;
      const inputHash = storedCapsule.inputHash;
      const ttlCountdown = storedCapsule.ttl;
      const lastValidated = storedCapsule.lastValidated.replace('T', ' ').substr(0, 19);

      block.innerHTML = `
        <div class="capsule-header">
          <div class="capsule-header-left">
            <span>CAP ${capsuleId}</span>
            <span class="capsule-badge ${data.status}">${data.status.toUpperCase()}</span>
          </div>
          <span style="font-size: 0.6rem; color: var(--text-dim);">${data.type}</span>
        </div>
        <div class="capsule-content">
          <div style="color: var(--text);">${data.description}</div>
          <div class="capsule-stats">
            <span class="capsule-stat">tok <span class="capsule-stat-value">${data.tokens || '0'}</span></span>
            <span class="capsule-stat">use <span class="capsule-stat-value">${data.reuses || '0'}</span></span>
            <span class="capsule-stat">$ <span class="capsule-stat-value">${data.saved || '0.00'}</span></span>
            ${data.ttl ? `<span class="capsule-stat">ttl <span class="capsule-stat-value">${data.ttl}</span></span>` : ''}
          </div>
        </div>
        <div class="capsule-tooltip" style="top: 100%; left: 0; margin-top: 4px;">
          <div class="capsule-tooltip-row"><span>Version</span><span>${packVersion}</span></div>
          <div class="capsule-tooltip-row"><span>Hash</span><span>${inputHash}</span></div>
          <div class="capsule-tooltip-row"><span>TTL</span><span>${ttlCountdown}</span></div>
          <div class="capsule-tooltip-row"><span>Validated</span><span>${lastValidated}</span></div>
        </div>
      `;
      terminal.appendChild(block);
      scrollToBottom();
    }

    function addInstructionPack(packName, steps) {
      const block = document.createElement('div');
      block.className = 'instruction-pack';
      block.id = `pack-${packName.replace(/\s/g, '-').toLowerCase()}`;
      const stepsHtml = steps.map((step, i) => `
        <div class="instruction-step" data-step="${i}">
          <span class="instruction-step-num">${i + 1}.</span>
          <span class="instruction-step-text">${step}</span>
        </div>
      `).join('');

      block.innerHTML = `
        <div class="instruction-header">
          <span>PACK ${packName}</span>
          <span style="margin-left: auto; font-size: 0.6rem; color: var(--text-dim);">${steps.length} steps</span>
        </div>
        <div class="instruction-content">${stepsHtml}</div>
      `;
      terminal.appendChild(block);
      scrollToBottom();
      return block;
    }

    function updateInstructionStep(packElement, stepIndex, status) {
      const step = packElement.querySelector(`[data-step="${stepIndex}"]`);
      if (step) {
        step.className = `instruction-step ${status}`;
      }
    }

    function addGatePrompt(gateId, message, onApprove, onModify, onAbort) {
      const gate = document.createElement('div');
      gate.className = 'gate-prompt';
      gate.id = gateId;
      gate.innerHTML = `
        <div class="gate-prompt-header">MANDATORY GATE — Human Approval Required</div>
        <div class="gate-prompt-text">${message}</div>
        <div class="gate-prompt-actions">
          <button class="gate-btn primary" data-action="approve">APPROVE</button>
          <button class="gate-btn" data-action="modify">MODIFY</button>
          <button class="gate-btn danger" data-action="abort">ABORT</button>
        </div>
      `;
      terminal.appendChild(gate);
      scrollToBottom();

      gate.querySelector('[data-action="approve"]').addEventListener('click', () => {
        gate.remove();
        onApprove && onApprove();
      });
      gate.querySelector('[data-action="modify"]').addEventListener('click', () => {
        gate.remove();
        onModify && onModify();
      });
      gate.querySelector('[data-action="abort"]').addEventListener('click', () => {
        gate.remove();
        onAbort && onAbort();
      });
    }

    // Toggle sidebar
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarToggle.classList.toggle('open');
      sidebarToggle.innerHTML = sidebar.classList.contains('open')
        ? '<span style="font-size: 0.5rem; font-weight: 600; letter-spacing: 0.06em;">GOV</span><span style="font-size: 0.7rem;">&gt;</span>'
        : '<span style="font-size: 0.5rem; font-weight: 600; letter-spacing: 0.06em;">GOV</span><span style="font-size: 0.7rem;">&lt;</span>';
    });

    // Export functions
    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Export Evidence Pack button
    document.getElementById('exportEvidenceBtn').addEventListener('click', async () => {
      const evidenceData = {
        exportedAt: new Date().toISOString(),
        storageMode: GIA.storageMode,
        workflowId: document.getElementById('workflowTag').textContent,
        hashChain: GIA.evidence.hashChain,
        chainVerification: await GIA.evidence.verifyChain(),
        packs: GIA.evidence.packs,
        disclaimer: 'LOCAL_DEMO storage - client-side only, not tamper-resistant. Production requires server-sealed evidence.'
      };
      const filename = `gia-evidence-${Date.now()}.json`;
      downloadJSON(evidenceData, filename);

      // Log to terminal
      addLine('success', '+', `exported evidence pack: <span class="hl-cyan">${filename}</span>`);
      addSpacer();
    });

    // Export Capsules button
    document.getElementById('exportCapsulesBtn').addEventListener('click', () => {
      const capsuleData = {
        exportedAt: new Date().toISOString(),
        storageMode: GIA.storageMode,
        capsuleCount: GIA.capsules.cache.size,
        capsules: Object.fromEntries(GIA.capsules.cache),
        disclaimer: 'LOCAL_DEMO storage - client-side only. Capsule provenance is demo-grade.'
      };
      const filename = `gia-capsules-${Date.now()}.json`;
      downloadJSON(capsuleData, filename);

      // Log to terminal
      addLine('success', '+', `exported capsules: <span class="hl-accent">${filename}</span>`);
      addSpacer();
    });

    // Export Full Audit Bundle button
    document.getElementById('exportFullBtn').addEventListener('click', async () => {
      // In demo mode, we create a combined JSON (no actual ZIP without a library)
      const bundleData = {
        exportedAt: new Date().toISOString(),
        storageMode: GIA.storageMode,
        workflowId: document.getElementById('workflowTag').textContent,

        // Evidence section
        evidence: {
          hashChain: GIA.evidence.hashChain,
          chainVerification: await GIA.evidence.verifyChain(),
          packs: GIA.evidence.packs
        },

        // Capsules section
        capsules: {
          count: GIA.capsules.cache.size,
          items: Object.fromEntries(GIA.capsules.cache)
        },

        // Runtime metrics
        metrics: {
          apiCalls: apiCalls,
          capsuleHits: capsuleHits,
          totalCost: currentCost,
          interruptCount: interruptCount,
          gatesPassed: gatesPassed,
          totalGates: totalGates,
          elapsedTime: timeMetric.textContent
        },

        // Governance state
        governance: {
          maiClassification: 'ADVISORY',
          integrityStatus: integrityStatus.textContent,
          riskLevel: riskLevel.textContent,
          confidenceLevel: confidenceLevel.textContent,
          driftStatus: driftStatus.textContent
        },

        disclaimer: 'LOCAL_DEMO audit bundle - client-side only, not tamper-resistant. Production requires server-sealed exports with cryptographic attestation.'
      };

      const filename = `gia-audit-bundle-${Date.now()}.json`;
      downloadJSON(bundleData, filename);

      // Log to terminal
      addLine('success', '+', `exported full audit bundle: <span class="hl-accent">${filename}</span>`);
      addLine('system', '*', `<span class="hl-dim">bundle includes: evidence, capsules, metrics, governance state</span>`);
      addSpacer();
    });

    // Auto-resize textarea
    inputField.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });

    // Handle input
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitInput();
      }
    });

    function submitInput() {
      const text = inputField.value.trim();
      if (!text) return;

      interruptCount++;
      updateInterrupts();

      // Add human line
      addLine('human', 'you:', text);
      addSpacer();

      // Process interrupt
      processInterrupt(text);

      inputField.value = '';
      inputField.style.height = 'auto';
    }

    function addLine(type, prefix, content, extras = '') {
      const line = document.createElement('div');
      line.className = `line ${type}`;
      line.innerHTML = `
        <span class="line-prefix">${prefix}</span>
        <span class="line-content">${content}${extras}</span>
      `;
      terminal.appendChild(line);
      scrollToBottom();
    }

    function addSpacer() {
      const spacer = document.createElement('div');
      spacer.className = 'spacer';
      terminal.appendChild(spacer);
    }

    function addBlock(title, content) {
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `
        <div class="block-header">${title}</div>
        <div class="block-content"><pre>${content}</pre></div>
      `;
      terminal.appendChild(block);
      scrollToBottom();
    }

    function addProgress(percent, text) {
      const existing = terminal.querySelector('.progress-line');
      if (existing) existing.remove();

      const progress = document.createElement('div');
      progress.className = 'progress-line';
      progress.innerHTML = `
        <span class="progress-text">${text}</span>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${percent}%"></div>
        </div>
        <span class="progress-text">${percent}%</span>
      `;
      terminal.appendChild(progress);
      scrollToBottom();
    }

    function typeText(type, prefix, text, speed = 15) {
      return new Promise(resolve => {
        const line = document.createElement('div');
        line.className = `line ${type}`;
        const prefixSpan = document.createElement('span');
        prefixSpan.className = 'line-prefix';
        prefixSpan.textContent = prefix;
        const contentSpan = document.createElement('span');
        contentSpan.className = 'line-content';
        const cursor = document.createElement('span');
        cursor.className = 'cursor';

        line.appendChild(prefixSpan);
        line.appendChild(contentSpan);
        contentSpan.appendChild(cursor);
        terminal.appendChild(line);

        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            contentSpan.insertBefore(document.createTextNode(text[i]), cursor);
            i++;
            scrollToBottom();
          } else {
            clearInterval(interval);
            cursor.remove();
            resolve();
          }
        }, speed);
      });
    }

    function scrollToBottom() {
      terminal.scrollTop = terminal.scrollHeight;
    }

    async function processInterrupt(text) {
      // Update status
      statusPill.className = 'status-pill paused';
      statusText.textContent = 'processing';

      await sleep(300);

      // Show interrupt processing
      await typeText('ai', 'gia:', `interrupt received. pausing workflow...`);
      addSpacer();

      await sleep(400);

      // Log interrupt
      addLine('gate', '>', `logged interrupt #${interruptCount} to evidence pack`,
        `<span class="evidence-badge">recorded</span>`);

      await sleep(300);

      // Re-evaluate
      await typeText('ai', 'gia:', `re-evaluating governance with new constraint...`);

      await sleep(500);

      addLine('gate', '+', `MAI classification unchanged: <span class="hl-yellow">ADVISORY</span>`);
      addLine('gate', '+', `gates re-validated. proceeding.`);

      addSpacer();

      // Resume with constraint
      await typeText('ai', 'gia:', `applying constraint: "${text}"`);

      await sleep(300);

      await typeText('step', '→', `resuming search with updated parameters...`);

      // Back to running
      statusPill.className = 'status-pill running';
      statusText.textContent = 'running';

      addSpacer();

      // Simulate continued work
      await sleep(800);
      await typeText('output', '  ', `filtering results...`);
      await sleep(500);
      addLine('success', '+', `found <span class="hl-bright">12</span> opportunities matching updated criteria`);

      addSpacer();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Pause button
    pauseBtn.addEventListener('click', () => {
      isPaused = !isPaused;
      if (isPaused) {
        statusPill.className = 'status-pill paused';
        statusText.textContent = 'paused';
        pauseBtn.textContent = 'RESUME';
        addLine('warning', '||', 'workflow paused by operator');
      } else {
        statusPill.className = 'status-pill running';
        statusText.textContent = 'running';
        pauseBtn.textContent = 'PAUSE';
        addLine('success', '>', 'workflow resumed');
      }
      addSpacer();
    });

    // Initial demo sequence
    async function runDemo() {
      addLine('system', '*', `<span class="hl-accent">GIA Console</span> v0.1.0 — governed AI execution terminal`);
      addLine('system', '*', `type anytime to interrupt, re-scope, or add constraints`);
      addSpacer();

      await sleep(500);

      addLine('gate', '>', `run initialized: <span class="hl-bright">WF-2026-0204-BD-001</span>`);
      addLine('gate', '+', `domain: <span class="hl-cyan">BD Capture</span> — authorized`);
      updateGates(1);
      addLine('gate', '+', `MAI classification: <span class="hl-yellow">ADVISORY</span>`);
      updateGates(2);
      addLine('gate', '+', `cost budget: $5.00 — approved`);
      updateGates(3);
      addSpacer();

      await sleep(600);

      // Show Instruction Pack
      const pack = addInstructionPack('Federal Opportunity Search', [
        'Parse search criteria from input',
        'Connect to SAM.gov API',
        'Execute search query',
        'Rank by relevance + deadline',
        'Generate evidence pack',
        'Present results for approval'
      ]);
      addSpacer();

      await sleep(500);

      await typeText('step', '→', 'starting workflow: federal-opportunity-search');
      updateCost(0.01);
      addSpacer();

      // Step 1
      updateInstructionStep(pack, 0, 'active');
      await sleep(400);

      await typeText('output', '  ', 'parsing search criteria...');
      await sleep(300);
      addBlock('search parameters', `keywords:   ["AI/ML", "cybersecurity", "cloud"]
naics:      541512, 541511
set-aside:  null
min-value:  $100,000`);
      updateInstructionStep(pack, 0, 'done');

      await sleep(500);

      // Step 2
      updateInstructionStep(pack, 1, 'active');
      await typeText('step', '→', 'connecting to SAM.gov API...');
      await sleep(800);
      addLine('success', '+', 'connection established');
      updateCost(0.02);
      updateApiCalls();
      updateInstructionStep(pack, 1, 'done');
      addSpacer();

      await sleep(400);

      // Step 3
      updateInstructionStep(pack, 2, 'active');
      await typeText('step', '→', 'executing search query...');
      addProgress(30, 'searching');

      await sleep(1000);
      addProgress(65, 'processing');
      updateCost(0.05);

      await sleep(800);
      addProgress(100, 'complete');

      await sleep(300);
      addLine('success', '+', `found <span class="hl-bright">47</span> opportunities matching criteria`);
      updateCost(0.04);
      updateApiCalls();
      updateInstructionStep(pack, 2, 'done');
      addSpacer();

      // Show cached capsule - this is where the magic happens
      await sleep(400);
      addCapsule('NAICS-541512-RANKING', {
        status: 'cached',
        type: 'Ranking Algorithm',
        description: 'Pre-trained relevance model for IT Professional Services (NAICS 541512)',
        tokens: '0',
        reuses: '47',
        saved: '0.12',
        ttl: '7d'
      });

      // Step 4
      updateInstructionStep(pack, 3, 'active');
      await sleep(400);

      await typeText('step', '→', 'applying cached ranking capsule...');
      await sleep(300);
      capsuleHits++;
      capsuleHitsMetric.textContent = capsuleHits;
      addLine('success', '+', `<span class="hl-accent">cache hit</span> — zero API calls for ranking`);
      updateInstructionStep(pack, 3, 'done');
      addSpacer();

      // Step 5
      updateInstructionStep(pack, 4, 'active');

      // Evidence Pack - using real hash generation
      await sleep(400);
      const evidencePack = GIA.evidence.create(
        document.getElementById('workflowTag').textContent,
        'SAM.gov API',
        '/opportunities/v2/search'
      );

      // Seal with actual query/response data (synthetic in demo)
      const queryData = { keywords: ['AI/ML', 'cybersecurity'], naics: [541512, 541511] };
      const responseData = { totalResults: 47, timestamp: Date.now() };
      await GIA.evidence.seal(evidencePack.id, queryData, responseData);
      evidencePack.negativeAssurance = 'No set-aside filter applied';

      addEvidencePack(evidencePack.id, {
        source: evidencePack.source,
        endpoint: evidencePack.endpoint,
        queryHash: evidencePack.queryHash,
        timestamp: evidencePack.timestamp,
        validation: evidencePack.validation,
        negativeAssurance: evidencePack.negativeAssurance
      });
      updateInstructionStep(pack, 4, 'done');

      await sleep(500);

      await typeText('output', '  ', 'applying relevance weights from capsule...');
      await sleep(400);
      await typeText('output', '  ', 'calculating deadline proximity scores...');
      await sleep(500);

      addSpacer();
      addLine('success', '+', `ranked <span class="hl-bright">Top 5</span> opportunities by relevance`);

      // Step 6
      updateInstructionStep(pack, 5, 'active');
      addSpacer();

      addBlock('top 5 results', `1. FA8750-26-R-0042  AI/ML Platform Services      95%  $4.2M   Due: Mar 15
2. W911NF-26-R-0089  Cyber Defense Analytics     91%  $2.8M   Due: Mar 22
3. N00024-26-R-0156  Cloud Migration Services    88%  $1.9M   Due: Apr 01
4. FA8075-26-R-0201  Data Engineering Support    85%  $3.1M   Due: Apr 10
5. W56KGU-26-R-0044  AI Training Infrastructure  82%  $5.6M   Due: Apr 18`);

      updateCost(0.02);
      await sleep(800);

      // Gate prompt before export
      addSpacer();
      addGatePrompt('gate-export',
        'Ready to export shortlist and generate capture plan. This action will create external artifacts.',
        async () => {
          addLine('gate', '+', 'Gate APPROVED by operator');
          updateGates(4);
          updateInstructionStep(pack, 5, 'done');
          addSpacer();

          // Phase 2: Post-approval workflow
          await typeText('step', '→', 'initiating capture plan generation...');
          await sleep(600);

          await typeText('output', '  ', 'loading opportunity details for FA8750-26-R-0042...');
          updateApiCalls();
          await sleep(400);

          await typeText('output', '  ', 'analyzing solicitation requirements...');
          updateCost(0.03);
          await sleep(500);

          addBlock('opportunity summary', `Solicitation:  FA8750-26-R-0042
Title:         AI/ML Platform Services for AFRL
Agency:        Air Force Research Laboratory
Value:         $4.2M (ceiling)
Type:          IDIQ, Task Order
Set-Aside:     Full & Open
Due:           March 15, 2026
POC:           sarah.chen@us.af.mil`);

          await sleep(500);

          await typeText('step', '→', 'generating win theme recommendations...');
          await sleep(400);

          // Use another cached capsule
          addCapsule('AFRL-WIN-THEMES', {
            status: 'cached',
            type: 'Win Theme Library',
            description: 'Historical win themes for Air Force Research Lab contracts',
            tokens: '0',
            reuses: '12',
            saved: '0.08',
            ttl: '90d'
          });

          capsuleHits++;
          capsuleHitsMetric.textContent = capsuleHits;
          addLine('success', '+', `<span class="hl-accent">cache hit</span> — win themes loaded from cache`);
          addSpacer();

          await sleep(400);

          addBlock('recommended win themes', `1. Technical Excellence
   → Emphasize AI/ML model governance and explainability
   → Highlight cleared personnel with AFRL experience

2. Mission Alignment
   → Reference AFRL's AI strategy and research priorities
   → Connect capabilities to specific lab directorates

3. Past Performance
   → Cite similar IDIQ work with DoD research labs
   → Include quantified outcomes and cost savings`);

          await sleep(600);

          await typeText('step', '→', 'compiling capture plan document...');
          await sleep(400);
          await typeText('output', '  ', 'adding competitive analysis...');
          await sleep(300);
          await typeText('output', '  ', 'inserting team structure recommendations...');
          await sleep(300);
          await typeText('output', '  ', 'finalizing executive summary...');
          await sleep(500);

          addLine('success', '+', 'capture plan compiled (12 pages)');
          addSpacer();

          // Final export
          await typeText('step', '→', 'exporting artifacts...');
          await sleep(400);

          // Sandboxed artifact paths with crypto-secure hash
          // Uses anonymous operator token - NO PII in hashes
          const artifactData = {
            workflowId: document.getElementById('workflowTag').textContent,
            timestamp: Date.now(),
            operatorToken: GIA.redact.operatorToken // Anonymous token, not email
          };
          const artifactHash = (await GIA.generateHash(artifactData)).slice(0, 12);
          addBlock('exported files', `📄 demo/artifacts/${artifactHash}-capture.pdf     12 pages
📊 demo/artifacts/${artifactHash}-matrix.xlsx      3 competitors
📋 demo/artifacts/${artifactHash}-tracker.csv      14 tasks
demo/artifacts/${artifactHash}-evidence.json    full audit trail

Note: Artifacts stored in sandboxed demo environment`);

          addSpacer();

          // Create reusable capsule from this run
          addCapsule('BD-SEARCH-AIML-2026', {
            status: 'new',
            type: 'Search Template',
            description: 'AI/ML federal opportunity search — reusable for similar queries',
            tokens: '1,247',
            reuses: '0',
            saved: '0.00',
            ttl: '30d'
          });
          addLine('system', '*', '<span class="hl-accent">capsule saved</span> → future AI/ML searches will skip ranking step');
          addSpacer();

          // Final summary
          setIntegrity('VERIFIED');
          setRisk('LOW');

          addLine('gate', '*', 'evidence pack sealed: <span class="hl-accent">FED-SEARCH-2026-0204-001</span>');
          addSpacer();

          // Completion summary block
          addBlock('workflow summary', `Status:        COMPLETE [OK]
Duration:      ${timeMetric.textContent}
API Calls:     ${apiCalls}
Capsule Hits:  ${capsuleHits} (saved ~$0.20)
Total Cost:    ${costTag.textContent}
Artifacts:     4 files exported
Evidence:      Sealed and verified`);

          addSpacer();
          addLine('system', '*', '<span class="hl-green">workflow complete.</span> all actions logged and auditable.');
          addLine('system', '*', '<span class="hl-dim">type "new search" to start another workflow</span>');

          statusPill.className = 'status-pill paused';
          statusText.textContent = 'complete';
          document.getElementById('modeTag').textContent = 'COMPLETE';
          document.getElementById('modeTag').style.background = 'rgba(34, 197, 94, 0.15)';
          document.getElementById('modeTag').style.color = 'var(--green)';
          document.getElementById('modeTag').style.borderColor = 'rgba(34, 197, 94, 0.3)';
        },
        () => {
          addLine('warning', '~', 'Gate MODIFY requested — awaiting new constraints');
          addSpacer();
          addLine('system', '*', '<span class="hl-dim">type your modifications below</span>');
        },
        () => {
          addLine('error', 'x', 'Gate ABORTED by operator');
          addSpacer();
          setIntegrity('SEALED');
          addLine('gate', '*', 'evidence pack sealed — no export performed');
          statusPill.className = 'status-pill paused';
          statusText.textContent = 'aborted';
          document.getElementById('modeTag').textContent = 'ABORTED';
          document.getElementById('modeTag').style.background = 'rgba(239, 68, 68, 0.15)';
          document.getElementById('modeTag').style.color = 'var(--red)';
          document.getElementById('modeTag').style.borderColor = 'rgba(239, 68, 68, 0.3)';
        }
      );
    }

    // Help button
    document.getElementById('helpBtn').addEventListener('click', () => {
      addSpacer();
      addLine('system', '*', '<span class="hl-accent">GIA Console Help</span>');
      addLine('system', '  ', '<span class="hl-dim">Enter</span>        — send interrupt/constraint');
      addLine('system', '  ', '<span class="hl-dim">Shift+Enter</span> — new line in input');
      addLine('system', '  ', '<span class="hl-dim">Escape</span>      — clear input');
      addLine('system', '  ', '<span class="hl-dim">&lt; sidebar</span>   — view governance status');
      addSpacer();
      addLine('system', '*', '<span class="hl-dim">type anytime to add constraints mid-workflow</span>');
      addSpacer();
    });

    // Abort button
    document.getElementById('abortBtn').addEventListener('click', () => {
      addLine('error', '⛔', 'workflow aborted by operator');
      addSpacer();
      statusPill.className = 'status-pill paused';
      statusText.textContent = 'aborted';
      addLine('gate', '*', 'evidence pack sealed — partial run archived');
      addSpacer();
      addLine('system', '*', '<span class="hl-dim">run terminated. evidence available for review.</span>');
    });

    // Escape to clear input
    inputField.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        inputField.value = '';
        inputField.style.height = 'auto';
      }
    });

    // Start demo
    runDemo();
  </script>

</body>
</html>
